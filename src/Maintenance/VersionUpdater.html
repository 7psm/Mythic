<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MythicMarket - Mise √† jour de version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d30 100%);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .splash-container {
            text-align: center;
            max-width: 600px;
            padding: 40px;
        }

        .logo {
            width: 140px;
            height: 140px;
            margin: 0 auto 40px;
            background: linear-gradient(135deg, #007acc 0%, #6f42c1 50%, #d4af37 100%);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 15px 40px rgba(0, 122, 204, 0.4);
            animation: logoGlow 2s ease-in-out infinite alternate;
            position: relative;
            overflow: hidden;
        }

        .logo::before {
            content: "M";
            font-size: 56px;
            font-weight: 900;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 2;
        }

        .logo::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: logoShine 3s ease-in-out infinite;
        }

        @keyframes logoGlow {
            from {
                box-shadow: 0 15px 40px rgba(0, 122, 204, 0.4);
                transform: scale(1);
            }
            to {
                box-shadow: 0 20px 50px rgba(111, 66, 193, 0.6);
                transform: scale(1.02);
            }
        }

        @keyframes logoShine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            50% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
            100% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
        }

        .title {
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 20px;
            color: #ffffff;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 18px;
            color: #cccccc;
            margin-bottom: 40px;
            font-weight: 300;
        }

        .status-container {
            margin: 30px 0;
            min-height: 60px;
        }

        .status-text {
            font-size: 16px;
            color: #4fc3f7;
            margin: 10px 0;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .status-text.show {
            opacity: 1;
            transform: translateY(0);
        }

        .status-text.success {
            color: #4caf50;
        }

        .status-text.warning {
            color: #ff9800;
        }

        .status-text.error {
            color: #f44336;
        }

        .loading-dots {
            display: inline-block;
            margin-left: 10px;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        .animated-dots {
            display: inline-block;
            margin-left: 5px;
        }

        .animated-dots::after {
            content: '';
            animation: dots 1.2s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin: 30px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007acc, #6f42c1);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .redirect-text {
            font-size: 14px;
            color: #888888;
            margin-top: 30px;
        }

        .redirect-link {
            color: #4fc3f7;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.3s ease;
        }

        .redirect-link:hover {
            border-bottom-color: #4fc3f7;
        }

        .version-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 12px;
            color: #666666;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4fc3f7;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }
    </style>
</head>
<body>
    <div class="splash-container">
        <div class="logo"></div>
        <h1 class="title">Mise √† jour de MythicMarket</h1>
        <p class="subtitle">V√©rification et mise √† jour de la version en cours...</p>
        
        <div class="status-container">
            <div class="status-text" id="status-1">
                <span class="spinner"></span>V√©rification de la version...
            </div>
            <div class="status-text" id="status-2"></div>
            <div class="status-text" id="status-3"></div>
            <div class="status-text" id="status-4"></div>
            <div class="status-text" id="status-5"></div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <p class="redirect-text">
            Si rien ne se passe, <a href="/index.html" class="redirect-link">ouvrez ce lien dans votre navigateur</a>.
        </p>
    </div>

    <div class="version-info" id="version-info">
        Version: <span id="current-version">Chargement...</span>
    </div>

    <script>
        // Service de mise √† jour de version avec v√©rification
        const STORAGE_KEY = 'mythic_version';
        const CACHE_VERSION_KEY = 'mythic_cache_version';
        const SPLASH_DELAY = 10000; // D√©lai minimum d'affichage du splash (10 secondes)

        // Version de l'application (mise √† jour automatiquement par le script updater)
        const APP_VERSION = "1.1.0";

        // Version de build (timestamp pour le cache busting)
        const BUILD_VERSION = String(Date.now());

        // Stockage de la version de build pour les prochains chargements
        localStorage.setItem('build_timestamp', BUILD_VERSION);

        class VersionUpdaterService {
            constructor() {
                this.statusElements = {
                    status1: document.getElementById('status-1'),
                    status2: document.getElementById('status-2'),
                    status3: document.getElementById('status-3'),
                    status4: document.getElementById('status-4'),
                    status5: document.getElementById('status-5')
                };
                this.progressFill = document.getElementById('progress-fill');
                this.versionInfo = document.getElementById('current-version');
                this.isVersionUpdated = false;
                this.startTime = Date.now();
            }

            // Afficher un message de statut avec animation
            showStatus(elementId, message, type = 'info', showSpinner = false) {
                const element = this.statusElements[elementId];
                if (!element) {
                    console.error('Element not found:', elementId);
                    return;
                }

                element.innerHTML = showSpinner ? 
                    `<span class="spinner"></span>${message}` : 
                    message;
                element.className = `status-text ${type}`;
                
                // Animation d'apparition
                setTimeout(() => {
                    element.classList.add('show');
                }, 100);
            }

            // Mettre √† jour la barre de progression
            updateProgress(percentage) {
                if (this.progressFill) {
                    this.progressFill.style.width = `${percentage}%`;
                }
            }

            // Attendre un d√©lai
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // Nettoyer compl√®tement le cache
            async clearAllCache() {
                console.log('üßπ Nettoyage complet du cache...');
                
                try {
                    // Nettoyer le localStorage (sauf les donn√©es importantes)
                    const importantKeys = ['cart', 'user_preferences'];
                    const keysToRemove = [];
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && !importantKeys.includes(key)) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    console.log('‚úÖ localStorage nettoy√©');

                    // Nettoyer le sessionStorage
                    sessionStorage.clear();
                    console.log('‚úÖ sessionStorage nettoy√©');

                    // Nettoyer le cache via l'API Cache
                    if ('caches' in window) {
                        const cacheNames = await caches.keys();
                        await Promise.all(
                            cacheNames.map(name => caches.delete(name))
                        );
                        console.log('‚úÖ Cache API nettoy√©');
                    }

                } catch (error) {
                    console.warn('‚ö†Ô∏è Erreur lors du nettoyage du cache:', error);
                }
            }

            // Comparer les versions de mani√®re intelligente
            compareVersions(version1, version2) {
                // S√©parer les versions en parties num√©riques
                const v1Parts = version1.split('.').map(Number);
                const v2Parts = version2.split('.').map(Number);
                
                // Normaliser les longueurs
                const maxLength = Math.max(v1Parts.length, v2Parts.length);
                while (v1Parts.length < maxLength) v1Parts.push(0);
                while (v2Parts.length < maxLength) v2Parts.push(0);
                
                // Comparer chaque partie
                for (let i = 0; i < maxLength; i++) {
                    if (v1Parts[i] < v2Parts[i]) return -1; // version1 < version2
                    if (v1Parts[i] > v2Parts[i]) return 1;  // version1 > version2
                }
                return 0; // versions √©gales
            }

            // V√©rifier la version et g√©rer les mises √† jour
            async checkVersion() {
                console.log('üîç V√©rification de la version...');
                this.showStatus('status1', 'V√©rification de la version...', 'info', true);
                this.updateProgress(20);

                await this.delay(2000);

                const lastVersion = localStorage.getItem(STORAGE_KEY);
                console.log(`üìä Version actuelle: ${APP_VERSION}`);
                console.log(`üìä Version pr√©c√©dente: ${lastVersion || 'Aucune'}`);

                // Comparer les versions de mani√®re intelligente
                const versionComparison = lastVersion ? this.compareVersions(lastVersion, APP_VERSION) : 1;
                const isNewVersion = versionComparison < 0; // Nouvelle version si APP_VERSION > lastVersion
                const isDowngrade = versionComparison > 0; // Downgrade si APP_VERSION < lastVersion

                if (isNewVersion) {
                    console.log('üÜï Nouvelle version d√©tect√©e!');
                    this.isVersionUpdated = true;
                    
                    this.showStatus('status2', `Recherche de la version ${APP_VERSION}<span class="animated-dots"></span>`, 'warning', true);
                    this.updateProgress(40);
                    await this.delay(2000);

                    this.showStatus('status3', `T√©l√©chargement de la version ${APP_VERSION}<span class="animated-dots"></span>`, 'warning', true);
                    this.updateProgress(50);
                    await this.delay(2000);

                    this.showStatus('status4', `Installation de la version ${APP_VERSION}<span class="animated-dots"></span>`, 'warning', true);
                    this.updateProgress(70);
                    await this.delay(2000);

                    // Nettoyer compl√®tement le cache
                    await this.clearAllCache();
                    await this.delay(1500);

                    this.showStatus('status5', `Version ${APP_VERSION} install√©e avec succ√®s !`, 'success');
                    this.updateProgress(90);

                    await this.delay(2000);

                    // Mettre √† jour la version stock√©e
                    localStorage.setItem(STORAGE_KEY, APP_VERSION);
                    localStorage.setItem(CACHE_VERSION_KEY, APP_VERSION);

                } else if (isDowngrade) {
                    console.log('‚¨áÔ∏è Downgrade de version d√©tect√©');
                    this.isVersionUpdated = true;
                    
                    this.showStatus('status2', `Retour √† la version ${APP_VERSION}<span class="animated-dots"></span>`, 'warning', true);
                    this.updateProgress(40);
                    await this.delay(2000);

                    this.showStatus('status3', `Restauration de la version ${APP_VERSION}<span class="animated-dots"></span>`, 'warning', true);
                    this.updateProgress(60);
                    await this.delay(2000);

                    // Nettoyer le cache pour le downgrade
                    await this.clearAllCache();
                    await this.delay(1500);

                    this.showStatus('status4', `Version ${APP_VERSION} restaur√©e avec succ√®s !`, 'success');
                    this.updateProgress(80);

                    await this.delay(2000);

                    // Mettre √† jour la version stock√©e
                    localStorage.setItem(STORAGE_KEY, APP_VERSION);
                    localStorage.setItem(CACHE_VERSION_KEY, APP_VERSION);

                } else {
                    console.log('‚úÖ Version actuelle charg√©e');
                    this.showStatus('status2', `Chargement de la version ${APP_VERSION}<span class="animated-dots"></span>`, 'success');
                    this.updateProgress(60);
                    await this.delay(2000);
                    
                    this.showStatus('status3', `Version ${APP_VERSION} charg√©e avec succ√®s !`, 'success');
                    this.updateProgress(80);
                    await this.delay(2000);
                }

                // Finalisation commune
                this.showStatus('status4', 'Initialisation des composants<span class="animated-dots"></span>', 'info');
                this.updateProgress(95);
                await this.delay(1500);

                this.showStatus('status5', 'Redirection en cours<span class="animated-dots"></span>', 'info');
                this.updateProgress(100);
                await this.delay(1000);

                return isNewVersion || isDowngrade;
            }

            // Rediriger vers la page principale
            async redirectToMain() {
                console.log('üîÑ Redirection vers la page principale...');
                
                // S'assurer que le d√©lai minimum est respect√©
                const elapsedTime = Date.now() - this.startTime;
                const remainingDelay = Math.max(0, SPLASH_DELAY - elapsedTime);
                
                if (remainingDelay > 0) {
                    await this.delay(remainingDelay);
                }

                // Animation de sortie
                document.body.classList.add('fade-out');
                
                await this.delay(500);

                // Redirection s√©curis√©e - uniquement vers des URLs autoris√©es
                const allowedUrls = [
                    '/index.html',
                    '/index.html',
                    'index.html'
                ];
                
                // Construire l'URL de redirection de mani√®re s√©curis√©e
                let redirectUrl = '/index.html?fromSplash=true';
                
                if (this.isVersionUpdated) {
                    // Ajouter des param√®tres de cache busting s√©curis√©s
                    const timestamp = Date.now().toString();
                    redirectUrl += `&v=${timestamp}&_bust=${timestamp}`;
                }
                
                // V√©rifier que l'URL est autoris√©e
                const baseUrl = redirectUrl.split('?')[0];
                if (allowedUrls.includes(baseUrl)) {
                    window.location.href = redirectUrl;
                } else {
                    // Fallback s√©curis√©
                    console.warn('‚ö†Ô∏è URL de redirection non autoris√©e, utilisation du fallback');
                    window.location.href = '/index.html?fromSplash=true';
                }
            }

            // Initialiser le service
            async initialize() {
                console.log('üöÄ Initialisation du service de mise √† jour...');
                
                // Afficher la version actuelle
                if (this.versionInfo) {
                    this.versionInfo.textContent = APP_VERSION;
                }

                try {
                    // V√©rifier la version
                    await this.checkVersion();
                    
                    // Rediriger
                    await this.redirectToMain();

                } catch (error) {
                    console.error('‚ùå Erreur lors de l\'initialisation:', error);
                    
                    // En cas d'erreur, rediriger quand m√™me apr√®s un d√©lai
                    this.showStatus('status2', 'Erreur de v√©rification, redirection...', 'error');
                    await this.delay(2000);
                    window.location.href = '../index.html';
                }
            }
        }

        // D√©marrer le service quand le DOM est pr√™t
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üé¨ D√©marrage du service de mise √† jour...');
            const versionUpdater = new VersionUpdaterService();
            versionUpdater.initialize();
        });
    </script>
</body>
</html>
