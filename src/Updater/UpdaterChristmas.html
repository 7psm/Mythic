<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MythicMarket - Mise √† jour de No√´l üéÑ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes snowfall {
      0% { transform: translateY(-10vh) translateX(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(110vh) translateX(100px); opacity: 0; }
    }

    @keyframes logoGlow {
      from {
        box-shadow: 0 15px 40px rgba(220, 38, 38, 0.6), 0 0 60px rgba(34, 197, 94, 0.3);
        transform: scale(1) rotate(0deg);
      }
      to {
        box-shadow: 0 20px 50px rgba(34, 197, 94, 0.6), 0 0 80px rgba(220, 38, 38, 0.4);
        transform: scale(1.02) rotate(2deg);
      }
    }

    @keyframes sparkle {
      0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
      50% { opacity: 1; transform: scale(1) rotate(180deg); }
    }

    @keyframes bellRing {
      0%, 100% { transform: rotate(0deg); }
      10% { transform: rotate(15deg); }
      20% { transform: rotate(-15deg); }
      30% { transform: rotate(10deg); }
      40% { transform: rotate(-10deg); }
      50% { transform: rotate(0deg); }
    }

    @keyframes twinkle {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    @keyframes dotBlink {
      0%, 20% { opacity: 0.2; }
      40% { opacity: 1; }
      60% { opacity: 0.6; }
      80%, 100% { opacity: 0.2; }
    }

    @keyframes fadeOut {
      to { opacity: 0; transform: scale(0.95); }
    }

    .snowflake {
      position: absolute;
      top: -10vh;
      color: white;
      font-size: 1.5em;
      opacity: 0.8;
      animation: snowfall linear infinite;
      pointer-events: none;
    }
  </style>
</head>
<body class="bg-[linear-gradient(135deg,#0f172a_0%,#1e293b_50%,#334155_100%)] text-white font-sans h-screen flex flex-col justify-center items-center overflow-hidden relative">

  <!-- Flocons de neige -->
  <div id="snowContainer" class="fixed inset-0 pointer-events-none z-0"></div>

  <div class="text-center max-w-[600px] p-10 relative z-10">

    <!-- LOGO NO√ãL -->
    <div class="w-[140px] h-[140px] mx-auto mb-10 rounded-3xl flex items-center justify-center bg-[linear-gradient(135deg,#dc2626_0%,#22c55e_50%,#fbbf24_100%)] relative overflow-hidden shadow-[0_15px_40px_rgba(220,38,38,0.6)] animate-[logoGlow_2s_ease-in-out_infinite_alternate]">
      <!-- √âtoile de No√´l -->
      <span class="text-[72px] z-10 animate-[twinkle_2s_ease-in-out_infinite]">‚≠ê</span>
      
      <!-- Paillettes -->
      <span class="absolute top-[20%] left-[20%] text-[24px] animate-[sparkle_3s_ease-in-out_infinite]">‚ú®</span>
      <span class="absolute bottom-[20%] right-[20%] text-[24px] animate-[sparkle_3s_ease-in-out_infinite] [animation-delay:1s]">‚ú®</span>
      
      <!-- Clochette -->
      <span class="absolute top-2 right-2 text-[20px] animate-[bellRing_2s_ease-in-out_infinite]">üîî</span>
    </div>

    <h1 class="text-[32px] font-light mb-3 tracking-wider">üéÑ Mise √† jour de No√´l üéÑ</h1>
    <p class="text-[14px] text-red-300 mb-5 font-light italic">¬´ Le P√®re No√´l pr√©pare vos cadeaux... ¬ª</p>

    <p class="text-[18px] text-[#cccccc] mb-10 font-light">V√©rification et mise √† jour de la version en cours...</p>

    <!-- STATUS -->
    <div class="my-7 min-h-[60px]">
      <div id="status-1" class="status-text text-[16px] text-green-400 my-2 opacity-0 translate-y-5 transition-all duration-500">
        <span class="inline-block w-5 h-5 border-2 border-white/30 border-t-green-400 rounded-full animate-spin mr-2"></span>
        V√©rification de la version...
      </div>
      <div id="status-2" class="status-text text-[16px] my-2 opacity-0 translate-y-5 transition-all duration-500"></div>
      <div id="status-3" class="status-text text-[16px] my-2 opacity-0 translate-y-5 transition-all duration-500"></div>
      <div id="status-4" class="status-text text-[16px] my-2 opacity-0 translate-y-5 transition-all duration-500"></div>
      <div id="status-5" class="status-text text-[16px] my-2 opacity-0 translate-y-5 transition-all duration-500"></div>
    </div>

    <!-- PROGRESS BAR - Candy Cane Style -->
    <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden my-7 shadow-inner">
      <div id="progress-fill" class="h-full bg-[linear-gradient(90deg,#dc2626,#22c55e,#fbbf24)] w-0 transition-[width] duration-300 rounded-full shadow-[0_0_10px_rgba(34,197,94,0.5)]"></div>
    </div>

    <p class="text-[14px] text-[#888] mt-7">üéÅ Si rien ne se passe,
      <a href="/index.html" class="text-green-400 no-underline border-b border-transparent hover:border-green-400 transition-colors"> ouvrez ce lien dans votre navigateur</a>.
    </p>
  </div>

  <!-- VERSION INFO avec d√©coration -->
  <div class="absolute bottom-5 right-5 text-[12px] text-[#666]">
    <span class="mr-2">üéÖ</span>
    Version: <span id="current-version">Chargement...</span>
    <span class="ml-2">‚ùÑÔ∏è</span>
  </div>

  <script>
    // =============================================
    // R√âCUP√âRATION VERSION DEPUIS ADMIN PANEL
    // =============================================
    function getAdminVersion() {
      try {
        // 1. Essayer de r√©cup√©rer la version actuelle depuis l'admin
        const currentVersion = localStorage.getItem('currentAppVersion');
        if (currentVersion) {
          console.log('‚úÖ Version trouv√©e dans l\'admin:', currentVersion);
          return currentVersion;
        }

        // 2. Si pas de version actuelle, chercher dans l'historique
        const history = JSON.parse(localStorage.getItem('versionHistory') || '[]');
        if (history.length > 0) {
          const latestVersion = history[history.length - 1].version;
          console.log('‚úÖ Version trouv√©e dans l\'historique:', latestVersion);
          // Sauvegarder comme version actuelle
          localStorage.setItem('currentAppVersion', latestVersion);
          return latestVersion;
        }

        // 3. Fallback : version par d√©faut
        console.log('‚ö†Ô∏è Aucune version trouv√©e, utilisation de 1.0.0');
        return '1.0.0';
      } catch (error) {
        console.error('‚ùå Erreur lecture version admin:', error);
        return '1.0.0';
      }
    }

    function getVersionHistory() {
      try {
        return JSON.parse(localStorage.getItem('versionHistory') || '[]');
      } catch {
        return [];
      }
    }


    // ====== EFFET NEIGE ======
    function createSnowflakes() {
      const snowContainer = document.getElementById('snowContainer');
      const snowflakes = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '‚úª', '‚úº'];
      
      setInterval(() => {
        const snowflake = document.createElement('div');
        snowflake.className = 'snowflake';
        snowflake.textContent = snowflakes[Math.floor(Math.random() * snowflakes.length)];
        snowflake.style.left = Math.random() * 100 + 'vw';
        snowflake.style.animationDuration = (Math.random() * 3 + 5) + 's';
        snowflake.style.fontSize = (Math.random() * 1 + 0.5) + 'em';
        snowflake.style.opacity = Math.random() * 0.6 + 0.4;
        
        snowContainer.appendChild(snowflake);
        
        setTimeout(() => {
          snowflake.remove();
        }, 8000);
      }, 300);
    }

    // D√©marrer l'effet neige
    createSnowflakes();

    // =============================================
    // CONFIGURATION
    // =============================================
    const STORAGE_KEY = 'mythic_loaded_version';
    const CACHE_VERSION_KEY = 'mythic_cache_version';
    const SPLASH_DELAY = 10000;

    // üéØ R√âCUP√âRER LA VERSION DEPUIS L'ADMIN
    const APP_VERSION = getAdminVersion();
    const BUILD_VERSION = String(Date.now());

    console.log('üöÄ Version cible:', APP_VERSION);
    localStorage.setItem('build_timestamp', BUILD_VERSION);

    // =============================================
    // SERVICE DE MISE √Ä JOUR
    // =============================================
    class VersionUpdaterService {
      constructor() {
        this.statusElements = {
          status1: document.getElementById('status-1'),
          status2: document.getElementById('status-2'),
          status3: document.getElementById('status-3'),
          status4: document.getElementById('status-4'),
          status5: document.getElementById('status-5')
        };
        this.progressFill = document.getElementById('progress-fill');
        this.versionInfo = document.getElementById('current-version');
        this.isVersionUpdated = false;
        this.startTime = Date.now();
      }

      showStatus(elementId, message, type = 'info', showSpinner = false) {
        const element = this.statusElements[elementId];
        if (!element) return;

        const spinnerColor = type === 'success' ? 'border-t-emerald-400' : 
                            type === 'warning' ? 'border-t-amber-400' : 
                            type === 'error' ? 'border-t-red-400' : 'border-t-cyan-300';

        element.innerHTML = showSpinner ?
          `<span class="inline-block w-4 h-4 border-2 border-white/30 ${spinnerColor} rounded-full animate-spin mr-3"></span>${message}` :
          message;

        const colorMap = { 
          info: 'text-cyan-300', 
          success: 'text-emerald-300', 
          warning: 'text-amber-300', 
          error: 'text-red-300' 
        };
        element.className = `text-[15px] my-2 transition-all duration-500 opacity-0 translate-y-5 font-light ${colorMap[type] ?? 'text-cyan-300'}`;

        setTimeout(() => {
          element.classList.add('opacity-100', 'translate-y-0');
        }, 100);
      }

      updateProgress(percentage) {
        if (this.progressFill) {
          this.progressFill.style.width = `${percentage}%`;
        }
      }

      delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      async clearAllCache() {
        console.log('üßπ Nettoyage du cache...');
        try {
          const importantKeys = ['cart', 'user_preferences', 'currentAppVersion', 'versionHistory', 'discountCodes', 'appliedDiscount'];
          const keysToRemove = [];

          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && !importantKeys.includes(key)) {
              keysToRemove.push(key);
            }
          }

          keysToRemove.forEach(key => localStorage.removeItem(key));
          sessionStorage.clear();

          if ('caches' in window) {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map(name => caches.delete(name)));
          }
          console.log('‚úÖ Cache nettoy√©');
        } catch (error) {
          console.warn('‚ö†Ô∏è Erreur cache:', error);
        }
      }

      compareVersions(version1, version2) {
        const v1Parts = version1.split('.').map(Number);
        const v2Parts = version2.split('.').map(Number);
        const maxLength = Math.max(v1Parts.length, v2Parts.length);
        
        while (v1Parts.length < maxLength) v1Parts.push(0);
        while (v2Parts.length < maxLength) v2Parts.push(0);

        for (let i = 0; i < maxLength; i++) {
          if (v1Parts[i] < v2Parts[i]) return -1;
          if (v1Parts[i] > v2Parts[i]) return 1;
        }
        return 0;
      }

      async checkVersion() {
        console.log('üîç V√©rification...');
        this.showStatus('status1', 'Analyse du syst√®me...', 'info', true);
        this.updateProgress(20);
        await this.delay(2000);

        const lastLoadedVersion = localStorage.getItem(STORAGE_KEY);
        console.log('üìä Version charg√©e pr√©c√©demment:', lastLoadedVersion || 'Aucune');
        console.log('üìä Version cible (depuis admin):', APP_VERSION);

        const versionComparison = lastLoadedVersion ? this.compareVersions(lastLoadedVersion, APP_VERSION) : 1;
        const isNewVersion = versionComparison < 0;
        const isDowngrade = versionComparison > 0;

        if (isNewVersion) {
          console.log('üÜô Mise √† jour d√©tect√©e:', lastLoadedVersion, '‚Üí', APP_VERSION);
          this.isVersionUpdated = true;

          this.showStatus('status2', `D√©tection version ${APP_VERSION}<span class="inline-flex ml-1"><span class="inline-block">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.1s]">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.2s]">.</span></span>`, 'warning', true);
          this.updateProgress(40);
          await this.delay(2000);

          this.showStatus('status3', `T√©l√©chargement ${APP_VERSION}<span class="inline-flex ml-1"><span class="inline-block">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.1s]">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.2s]">.</span></span>`, 'warning', true);
          this.updateProgress(50);
          await this.delay(2000);

          this.showStatus('status4', `Installation ${APP_VERSION}<span class="inline-flex ml-1"><span class="inline-block">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.1s]">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.2s]">.</span></span>`, 'warning', true);
          this.updateProgress(70);
          await this.delay(2000);

          await this.clearAllCache();
          await this.delay(1500);

          this.showStatus('status5', `Version ${APP_VERSION} install√©e`, 'success');
          this.updateProgress(90);
          await this.delay(2000);

          localStorage.setItem(STORAGE_KEY, APP_VERSION);
          localStorage.setItem(CACHE_VERSION_KEY, APP_VERSION);

        } else if (isDowngrade) {
          console.log('‚¨áÔ∏è Rollback d√©tect√©:', lastLoadedVersion, '‚Üí', APP_VERSION);
          this.isVersionUpdated = true;

          this.showStatus('status2', `Restauration ${APP_VERSION}<span class="inline-flex ml-1"><span class="inline-block">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.1s]">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.2s]">.</span></span>`, 'warning', true);
          this.updateProgress(40);
          await this.delay(2000);

          this.showStatus('status3', `Synchronisation ${APP_VERSION}<span class="inline-flex ml-1"><span class="inline-block">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.1s]">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.2s]">.</span></span>`, 'warning', true);
          this.updateProgress(60);
          await this.delay(2000);

          await this.clearAllCache();
          await this.delay(1500);

          this.showStatus('status4', `Version ${APP_VERSION} restaur√©e`, 'success');
          this.updateProgress(80);
          await this.delay(2000);

          localStorage.setItem(STORAGE_KEY, APP_VERSION);
          localStorage.setItem(CACHE_VERSION_KEY, APP_VERSION);

        } else {
          console.log('‚úÖ Version actuelle OK');
          this.showStatus('status2', `Chargement ${APP_VERSION}<span class="inline-flex ml-1"><span class="inline-block">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.1s]">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.2s]">.</span></span>`, 'success');
          this.updateProgress(60);
          await this.delay(2000);

          this.showStatus('status3', `Version ${APP_VERSION} pr√™te`, 'success');
          this.updateProgress(80);
          await this.delay(2000);
        }

        this.showStatus('status4', 'Initialisation<span class="inline-flex ml-1"><span class="inline-block">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.1s]">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.2s]">.</span></span>', 'info');
        this.updateProgress(95);
        await this.delay(1500);

        this.showStatus('status5', 'Redirection<span class="inline-flex ml-1"><span class="inline-block">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.1s]">.</span><span class="inline-block animate-[dotBlink_1.2s_linear_infinite] delay-[0.2s]">.</span></span>', 'info');
        this.updateProgress(100);
        await this.delay(1000);

        return isNewVersion || isDowngrade;
      }

      async redirectToMain() {
        const elapsedTime = Date.now() - this.startTime;
        const remainingDelay = Math.max(0, SPLASH_DELAY - elapsedTime);

        if (remainingDelay > 0) await this.delay(remainingDelay);

        document.body.classList.add('animate-[fadeOut_0.5s_ease-out_forwards]');
        await this.delay(500);

        let redirectUrl = '/index.html?fromSplash=true';
        if (this.isVersionUpdated) {
          const timestamp = Date.now().toString();
          redirectUrl += `&v=${APP_VERSION}&_bust=${timestamp}`;
        }

        console.log('üîÑ Redirection vers:', redirectUrl);
        window.location.href = redirectUrl;
      }

      async initialize() {
        if (this.versionInfo) {
          this.versionInfo.textContent = APP_VERSION;
        }

        try {
          await this.checkVersion();
          await this.redirectToMain();
        } catch (error) {
          console.error('‚ùå Erreur:', error);
          this.showStatus('status2', 'Erreur, redirection...', 'error');
          await this.delay(2000);
          window.location.href = '/index.html';
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const versionUpdater = new VersionUpdaterService();
      versionUpdater.initialize();
    });
  </script>
</body>
</html>