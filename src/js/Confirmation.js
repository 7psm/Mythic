document.addEventListener('DOMContentLoaded', function() {
  // Etat des Variables
  let isModalOpen = false;
  let screenshotTaken = false;
  let isSubmitting = false;
  let showVendors = false;
  let selectedVendor = "";
  let orderData = {};
  
  // El√©ments DOM
  const submitButton = document.getElementById('submit-order');
  const screenshotModal = document.getElementById('screenshot-modal');
  const vendorModal = document.getElementById('vendor-modal');
  const notYetBtn = document.getElementById('not-yet-btn');
  const screenshotTakenBtn = document.getElementById('screenshot-taken-btn');
  const continueToVendorBtn = document.getElementById('continue-to-vendor');
 const confirmationModal = document.getElementById('confirmation-modal');
  const confirmationOkBtn = document.getElementById('confirmation-ok-btn');
  
  // Initialisation de la Page
  function initialize() {
    console.log("=== INITIALISATION PAGE CONFIRMATION ===");
    
    // R√©cup√©rer les donn√©es de commande √† partir de diff√©rentes sources.
    loadOrderData();
    
    // V√©rifier si nous disposons des donn√©es de commande -> rediriger si ce n'est pas le cas.
    if (!orderData.orderNumber) {
      console.log("Pas de donn√©es de commande, redirection vers l'accueil");
      window.location.href = '/index.html';
      return;
    }
    
    // Remplir la page avec les donn√©es de commande.
    populateOrderData();
    
    // Configurer les √©couteurs d'√©v√©nements.
    setupEventListeners();

     setTimeout(() => {
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = 'Soumettre la Commande';
      }
    }, 500);
    
    console.log("=== INITIALISATION TERMIN√âE ===");
  }
  
  // Charger les donn√©es de commande √† partir du localStorage et des param√®tres URL.
  function loadOrderData() {
    try {
      // Obtenir le num√©ro de commande √† partir de l'URL
      const urlParams = new URLSearchParams(window.location.search);
      const orderNumber = urlParams.get('order');
      
      // Obtenir les donn√©es du formulaire crypt√©es
      const encryptedData = localStorage.getItem("secureCheckoutData");
      let formData = null;
      
      if (encryptedData) {
        formData = decryptData(encryptedData);
      }
      
      // Obtenir les donn√©es du panier
      const cart = JSON.parse(localStorage.getItem("cart") || "[]");
      
      // Obtenir les m√©thodes s√©lectionn√©es
      const selectedShippingMethod = localStorage.getItem("selectedShippingMethod") || "Livraison Standard";
      const selectedPaymentMethod = localStorage.getItem("selectedPaymentMethod") || "PayPal";
      
      // Cr√©er un objet de donn√©es de commande
      orderData = {
        orderNumber: orderNumber || generateOrderNumber(),
        orderDate: new Date().toISOString(),
        name: formData?.customerInfo?.name || 'Client',
        email: formData?.customerInfo?.email || 'Non renseign√©',
        phoneNumber: formData?.customerInfo?.phone || 'Non renseign√©',
        discord: formData?.customerInfo?.discord || 'Non renseign√©',
        address: formData?.shippingInfo?.address || 'Non renseign√©',
        city: formData?.shippingInfo?.city || 'Non renseign√©',
        country: formData?.shippingInfo?.country || 'Non renseign√©',
        postalCode: formData?.shippingInfo?.postalCode || 'Non renseign√©',
        orderItems: cart,
        shippingMethod: {
          name: selectedShippingMethod,
          price: selectedShippingMethod.includes('Express') ? 2.50 : 0,
          delivery: selectedShippingMethod.includes('Express') ? '15-20min' : '6-12h'
        },
        paymentMethod: selectedPaymentMethod
      };
      
      console.log("Donn√©es de commande charg√©es:", orderData);
      
    } catch (error) {
      console.error("Erreur lors du chargement des donn√©es:", error);
      orderData = { orderNumber: null };
    }
  }
  
  // D√©crypter les donn√©es du formulaire
  function decryptData(encryptedData) {
    try {
      const decoded = decodeURIComponent(atob(encryptedData));
      const originalData = decoded.replace("checkout_secure_key_2024", '');
      return JSON.parse(originalData);
    } catch (error) {
      console.error("Erreur de d√©chiffrement:", error);
      return null;
    }
  }
  
  // G√©n√©rer un num√©ro de commande
  function generateOrderNumber() {
    const timestamp = Date.now().toString().slice(-8);
    return `PM-${timestamp}`;
  }
  
  // Formater la date pour l'affichage
  function formatDate(dateString) {
    if (!dateString) return new Date().toLocaleDateString('fr-FR');
    
    const date = new Date(dateString);
    return date.toLocaleDateString('fr-FR', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  // Remplir la page avec les donn√©es de la commande
  function populateOrderData() {
    console.log("Population des donn√©es sur la page...");
    
    // En-t√™tes de la Commande
    const orderNumberEl = document.getElementById('order-number');
    const orderDateEl = document.getElementById('order-date');
    const customerNameEl = document.getElementById('customer-name');
    
    if (orderNumberEl) orderNumberEl.textContent = orderData.orderNumber;
    if (orderDateEl) orderDateEl.textContent = formatDate(orderData.orderDate);
    if (customerNameEl) customerNameEl.textContent = orderData.name;
    
    // Informations Client
    document.getElementById('contact-name').textContent = orderData.name;
    document.getElementById('contact-email').textContent = orderData.email;
    document.getElementById('contact-phone').textContent = orderData.phoneNumber;
    document.getElementById('contact-discord').textContent = orderData.discord;
    
    // Informations de livraison
    document.getElementById('shipping-address').textContent = orderData.address;
    document.getElementById('shipping-city').textContent = orderData.city;
    document.getElementById('shipping-country').textContent = orderData.country;
    document.getElementById('shipping-postal').textContent = orderData.postalCode;
    
    // Modes de livraison et de paiement
    document.getElementById('shipping-method').textContent = orderData.shippingMethod.name;
    document.getElementById('shipping-delivery').textContent = orderData.shippingMethod.delivery;
    document.getElementById('payment-method').textContent = orderData.paymentMethod;
    
    // Articles Command√©s
    populateOrderItems();
    
    // R√©capitulatif de la commande
    calculateAndDisplayTotals();
    
    console.log("Population des donn√©es termin√©e");
  }
  
  // Remplir les articles command√©s
  function populateOrderItems() {
    const orderItemsContainer = document.getElementById('order-items');
    if (!orderItemsContainer) return;
    
    orderItemsContainer.innerHTML = '';
    
    orderData.orderItems.forEach(item => {
      const itemTotal = item.price * item.quantity;
      
      const orderItem = document.createElement('div');
      orderItem.className = 'order-item';
      orderItem.innerHTML = `
        <div class="item-name">
          ${item.name}
          <span>x${item.quantity}</span>
        </div>
        <div class="item-price">‚Ç¨${itemTotal.toFixed(2)}</div>
      `;
      orderItemsContainer.appendChild(orderItem);
    });
  }
  
  // Calculer et afficher les totaux
  function calculateAndDisplayTotals() {
    const subtotal = orderData.orderItems.reduce(
      (total, item) => total + (item.price * item.quantity), 
      0
    );
    
    const shippingCost = orderData.shippingMethod.price || 0;
    const total = subtotal + shippingCost;
    
    // Mettre √† jour l'affichage
    document.getElementById('subtotal').textContent = `‚Ç¨${subtotal.toFixed(2)}`;
    document.getElementById('shipping-cost').textContent = shippingCost === 0 ? 'Gratuit' : `‚Ç¨${shippingCost.toFixed(2)}`;
    document.getElementById('total-cost').textContent = `‚Ç¨${total.toFixed(2)}`;
    
    console.log("Totaux calcul√©s:", { subtotal, shippingCost, total });
  }
  
  // Configurer les √©couteurs d'√©v√©nements
  function setupEventListeners() {
    // Clic sur le bouton ¬´ Soumettre ¬ª
    if (submitButton) {
      submitButton.addEventListener('click', handleSubmitClick);
    } else {
      console.error('‚ùå Bouton submit non trouv√©');
    }
    
    // Boutons modaux de capture d'√©cran
    if (notYetBtn) {
      notYetBtn.addEventListener('click', () => {
        console.log('Clic sur "Pas encore"');
        closeModal(screenshotModal);
      });
    } else {
      console.error('‚ùå Bouton "Pas encore" non trouv√©');
    }
    
    if (screenshotTakenBtn) {
      screenshotTakenBtn.addEventListener('click', confirmScreenshotTaken);
    } else {
      console.error('‚ùå Bouton "J\'ai pris une capture" non trouv√©');
    }
    
    // Bouton modal du fournisseur
    if (continueToVendorBtn) {
      continueToVendorBtn.addEventListener('click', openVendorDiscord);
    } else {
      console.error('‚ùå Bouton "Continuer vers le Vendeur" non trouv√©');
    }

    // Bouton OK du modal de confirmation
    if (confirmationOkBtn) {
      confirmationOkBtn.addEventListener('click', () => {
      window.location.href = '/index.html';
      });
    } else {
      console.error('‚ùå Bouton "OK Confirmation" non trouv√©');
    }
    
    // Fermer les modaux en cliquant en dehors
    [screenshotModal, vendorModal].forEach(modal => {
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            console.log('Clic √† l\'ext√©rieur du modal, fermeture...');
            closeModal(modal);
          }
        });
      }
    });
    
    // Test d'affichage des modales au chargement (pour debug)
    console.log('üîç Debug - √âl√©ments modales:');
    console.log('Screenshot modal:', screenshotModal ? 'Trouv√©' : 'Non trouv√©');
    console.log('Vendor modal:', vendorModal ? 'Trouv√©' : 'Non trouv√©');
    
    console.log("Event listeners configur√©s");
  }
  
  // G√©rer le clic du bouton ¬´ Soumettre ¬ª
  function handleSubmitClick(e) {
    e.preventDefault();
  if (isSubmitting) {
    console.log("D√©j√† en cours, clic ignor√©.");
    return;
  }

  if (!screenshotTaken) {
    console.log("Demande capture d'√©cran");
    openModal(screenshotModal);
  } else {
    console.log("Capture OK, envoi commande");
    showVendorModal();
  }
}
  
  // G√©rer la confirmation par l'utilisateur qu'il a pris une capture d'√©cran
  function confirmScreenshotTaken() {
    console.log("Capture d'√©cran confirm√©e");
    screenshotTaken = true;
    closeModal(screenshotModal);
    
    // NE PAS afficher le modal vendeur ici
    // Il s'affichera quand l'utilisateur cliquera √† nouveau sur "Soumettre la commande"
    console.log('Capture d\'√©cran confirm√©e, retour √† la page principale');
  }
  
  // Envoyer la commande via Discord
 async function submitOrder() {
  console.log("Soumission de la commande...");
  setSubmitting(true);

  try {
    const success = await DiscordOrderService.sendOrder(orderData);

    if (success) {
      console.log("Commande envoy√©e avec succ√®s vers Discord");
      return true;
    } else {
      console.error("√âchec de l'envoi de la commande vers Discord");
      // Supprime cette ligne : alert("Erreur lors de l'envoi de la commande. Veuillez r√©essayer.");
      return false;
    }
  } catch (error) {
    console.error("Erreur lors de la soumission:", error);
    // Supprime cette ligne : alert("Une erreur s'est produite. Veuillez r√©essayer.");
    return false;
  } finally {
    setSubmitting(false); // Toujours r√©activer le bouton
  }
}
  
  // Envoyer la commande √† Discord 
  async function sendOrderToDiscord(orderData) {
    try {
      console.log("Envoi des donn√©es de commande vers Discord...");
      
      // Formatage des donn√©es pour Discord
      const discordData = {
        numeroCommande: orderData.orderNumber,
        nom: orderData.name,
        email: orderData.email,
        pseudoDiscord: orderData.discord,
        telephone: orderData.phoneNumber,
        adresse: orderData.address,
        ville: orderData.city,
        codePostal: orderData.postalCode,
        pays: orderData.country,
        articles: orderData.orderItems.map(item => ({
          nom: item.name,
          quantite: item.quantity,
          prix: item.price
        })),
        methodeLivraison: orderData.shippingMethod.name,
        delaiLivraison: orderData.shippingMethod.delivery,
        fraisLivraison: orderData.shippingMethod.price,
        methodePaiement: orderData.paymentMethod,
        dateCommande: orderData.orderDate
      };
      
      // Simuler l'envoi vers Discord (remplacez par votre vraie API Discord)
      return new Promise((resolve) => {
        setTimeout(() => {
          console.log("üì® Donn√©es envoy√©es vers Discord:", discordData);
          
          // Simulation d'un embed Discord
          console.log("üé® Embed Discord cr√©√©:");
          console.log(`Titre: üõí Nouvelle commande ${discordData.numeroCommande}`);
          console.log(`Client: ${discordData.nom} (${discordData.pseudoDiscord})`);
          console.log(`Articles: ${discordData.articles.length} article(s)`);
          console.log(`Total: ‚Ç¨${(discordData.articles.reduce((t, a) => t + (a.prix * a.quantite), 0) + discordData.fraisLivraison).toFixed(2)}`);
          
          resolve(true); // Simuler le succ√®s
        }, 1500);
      });
      
    } catch (error) {
      console.error("Erreur lors de l'envoi vers Discord:", error);
      return false;
    }
  }
  
  // Afficher la fen√™tre modale du fournisseur
  function showVendorModal() {
    selectedVendor = "Incognito Market";
    console.log('Affichage du modal vendeur...');
    
    // Envoyer les donn√©es vers Discord avant d'afficher le modal
    submitOrder().then(() => {
      // Afficher le modal vendeur apr√®s l'envoi r√©ussi
      openModal(vendorModal);
    });
  }
  
  // G√©rer la s√©lection du fournisseur
  function handleVendorSelect(vendor) {
    selectedVendor = vendor;
    console.log("Vendeur s√©lectionn√©:", vendor);
  }
  
  // Ouvrir Discord du vendeur
  function openVendorDiscord() {
  console.log("Redirection vers Discord du vendeur:", selectedVendor);

  // Enregistrer la fin de la commande dans localStorage
  localStorage.setItem('orderCompleted', JSON.stringify({
    orderNumber: orderData.orderNumber,
    completedAt: new Date().toISOString(),
    vendor: selectedVendor
  }));

  // üõí R√âINITIALISER LE PANIER
  console.log("R√©initialisation du panier...");
  localStorage.removeItem('cart');
  localStorage.removeItem('propMoneyCart');
  localStorage.removeItem('secureCheckoutData');
  localStorage.removeItem('selectedShippingMethod');
  localStorage.removeItem('selectedPaymentMethod');

  // R√©initialiser le compteur du panier
  const cartCountElement = document.querySelector('.cart-count');
  if (cartCountElement) {
    cartCountElement.textContent = '0';
    cartCountElement.style.display = 'flex';
  }

  console.log("‚úÖ Panier r√©initialis√© avec succ√®s");

  // Ouvrir le lien Discord
  const discordUrl = 'https://discord.gg/beC8cFZaXH';
  console.log("Ouverture de Discord:", discordUrl);
  window.open(discordUrl, '_blank');

  // Fermer le modal vendeur
  closeModal(vendorModal);

  // ‚úÖ Afficher le message de remerciement apr√®s 1 seconde
  setTimeout(() => {
  console.log("üéâ Ouverture du modal de remerciement");
  openModal(confirmationModal);
  }, 1000)};

  // D√©finir l'√©tat d'envoie
  function setSubmitting(submitting) {
  isSubmitting = submitting;

  if (submitButton) {
    submitButton.disabled = submitting;
    submitButton.textContent = submitting ? 'Envoi en cours...' : 'Soumettre la Commande';
  }
}
  
  // Ouvrir le Modal
  function openModal(modal) {
    if (modal) {
      console.log('Ouverture du modal:', modal.id);
      modal.classList.add('active');
      isModalOpen = true;
    } else {
      console.error('Modal non trouv√© pour ouverture');
    }
  }
  
  // Fermer le Modal
  function closeModal(modal) {
    if (modal) {
      console.log('Fermeture du modal:', modal.id);
      modal.classList.remove('active');
      isModalOpen = false;
    } else {
      console.error('Modal non trouv√© pour fermeture');
    }
  }
  
  // Public API pour debugger
  window.confirmationPage = {
    orderData,
    initialize,
    handleSubmitClick,
    confirmScreenshotTaken,
    openVendorDiscord,
    loadOrderData,
    sendOrderToDiscord
  };
  
  // Initialiser la page
  initialize();
});