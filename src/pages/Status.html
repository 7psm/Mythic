<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IncognitoMarket - No.1 Shop All Over Discord</title>
    <link rel="icon" href="/public/logo.png">
    <!-- /////////////////////////////////////////////////////////////////////////
         ////////////////////       Importation & Files       ////////////////////
         /////////////////////////////////////////////////////////////////////////-->
    <link rel="stylesheet" href="../styles/GlobalStyle.css">
    <link rel="stylesheet" href="../styles/NavBar.css">
    <script src="/Crypted/Product.min.js" defer></script>
    <script src="../js/navbar-script.js"></script>

    <!-- ///////////////////////////////////////////////////////////////////
         ////////////////////       Fonts & Icons       ////////////////////
         ///////////////////////////////////////////////////////////////////-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <!-- Open Graph / Facebook / Discord -->
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://mythicmarket.netlify.app/">
        <meta property="og:title" content="IncognitoMarket - No.1 Shop All Over Discord">
        <meta property="og:description" content="Nos produits sont l√©gaux et fiables pour r√©pondre aux plus hauts standards d'authenticit√©.">
        <meta property="og:image" content="https://mythicmarket.netlify.app/public/banner.png">
        <meta property="og:image:width" content="1200">
        <meta property="og:image:height" content="630">
        <meta property="og:image:alt" content="IncognitoMarket Banner">
        <meta property="og:image:type" content="public/banner.png">

<!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="https://mythicmarket.netlify.app/">
        <meta property="twitter:title" content="IncognitoMarket - No.1 Shop All Over Discord">
        <meta property="twitter:description" content="Nos produits sont l√©gaux et fiables pour r√©pondre aux plus hauts standards d'authenticit√©.">
        <meta property="twitter:image" content="https://mythicmarket.netlify.app/public/banner.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: #0f0f0f;
      color: #f1f1f1;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      flex-direction: column;
    }

    /* Espace sous la navbar fixe */
    .top-spacer { height: 80px; width: 100%; }

    .status-container {
      max-width: 700px;
      width: 100%;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 14px;
      padding: 24px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.4s ease-in-out;
    }

    .status-tag {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 14px;
    }

    .tag-online { background: rgba(67, 184, 97, 0.2); color: #43b861; }
    .tag-maintenance { background: rgba(254, 231, 92, 0.15); color: #fee75c; }
    .tag-offline { background: rgba(237, 66, 69, 0.2); color: #ed4245; }
    .tag-critical { background: rgba(240, 71, 71, 0.25); color: #f04747; }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 6px;
      text-align: center;
    }

    .time-range {
      font-size: 0.9rem;
      color: #aaa;
      margin-bottom: 20px;
      text-align: center;
    }

    .details {
      background: #121212;
      padding: 18px;
      border-radius: 10px;
      border: 1px solid #2a2a2a;
      margin-bottom: 16px;
    }

    .details p {
      font-size: 0.95rem;
      line-height: 1.6;
      margin-bottom: 8px;
      color: #ddd;
      text-align: center;
    }

    .details strong { color: #fff; }

    .status-footer {
      font-size: 0.8rem;
      color: #666;
      text-align: center;
      margin-top: 20px;
    }

    .admin-panel {
      max-width: 700px;
      width: 100%;
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 14px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .admin-title {
      color: #f39c12;
      font-size: 1.2rem;
      margin: 0;
    }

    .close-btn {
      background: #d32f2f;
      border: 1px solid #d32f2f;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .close-btn:hover {
      background: #b71c1c;
      border-color: #b71c1c;
      transform: scale(1.1);
    }

    .buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .updates-box {
      background: #121212;
      padding: 16px 20px 20px 20px; /* retir√© padding top au-dessus du titre */
      border-radius: 10px;
      border: 1px solid #2a2a2a;
      margin-top: 12px;
      white-space: pre-wrap;
      color: #ddd;
    }
    .updates-box h3 { color: #f39c12; margin-bottom: 10px; letter-spacing: .2px; }
    .updates-subtitle { color:#aaa; font-size:.9rem; margin-bottom:8px; }
    .updates-list { list-style: none; padding-left: 0; margin: 10px 0 0 0; }
    .updates-list li { 
      margin: 8px 0; 
      line-height: 1.5; 
      color:#e6e6e6;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 8px;
      padding: 8px 12px 8px 32px;
      position: relative;
    }
    .updates-list li::before {
      content: '\2022';
      position: absolute; left: 12px; top: 8px;
      color: #f5c84b; font-weight: 900;
    }

    button {
      background: #222;
      border: 1px solid #444;
      padding: 8px 14px;
      border-radius: 8px;
      color: #eee;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    button:hover {
      background: #333;
      border-color: #666;
    }

    .loading {
      text-align: center;
      color: #aaa;
      font-style: italic;
    }

    .error {
      background: rgba(237, 66, 69, 0.1);
      border: 1px solid #ed4245;
      color: #ed4245;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 16px;
    }

    .auto-refresh {
      font-size: 0.8rem;
      color: #888;
      text-align: center;
      margin-top: 10px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 600px) {
      .buttons {
        flex-direction: column;
        align-items: center;
      }
      
      button {
        width: 200px;
      }
    }
  </style>
</head>
<body>
  <script>
    (function(){
      try{
        var url=new URL(window.location.href);
        if(url.search||url.hash){
          history.replaceState({},document.title,url.origin+url.pathname);
        }
      }catch(e){}
    })();
  </script>

    <nav class="navbar-container">
            <div class="nav-links">
                <a href="/index.html" class="nav-link">Mythic-Market</a>
                <a href="Status.html" class="nav-link">Status</a>
                <a href="" class="nav-link">Maintenance </a>
                <a href="" class="nav-link">Incidents Ant√©rieurs</a>
            </div>
            <div class="navbar-separator"></div>
        </nav>

        <div class="top-spacer"></div>

  <!-- Panel Admin (visible seulement pour l'admin) -->
  <div id="adminPanel" class="admin-panel" style="display: none;">
    <div class="admin-header">
    <div class="admin-title">üîß Panel Administrateur</div>
      <button onclick="closeAdminPanel()" class="close-btn" title="Fermer le panel">‚úï</button>
    </div>
    <div class="buttons">
      <button onclick="updateStatus('online')">üü¢ Online</button>
      <button onclick="updateStatus('maintenance')">üõ† Maintenance</button>
      <button onclick="updateStatus('offline')">üî¥ Offline</button>
      <button onclick="updateStatus('critical')">‚ö†Ô∏è Critical</button>
      <button onclick="toggleUpdatesEditor()">üìù Update</button>
      <button onclick="toggleUpdatesView()">üì¢ Afficher mises √† jour</button>
      <button onclick="toggleUpdatesEnabled(true)">‚úÖ Activer</button>
      <button onclick="toggleUpdatesEnabled(false)">‚õî D√©sactiver</button>
    </div>
    <div id="adminMessage" style="text-align: center; color: #aaa; font-size: 0.9rem;"></div>
    <div id="updatesEditor" style="display:none; margin-top:12px;">
      <textarea id="updatesText" style="width:100%; min-height:120px; background:#0f0f0f; color:#eee; border:1px solid #333; border-radius:8px; padding:10px;"></textarea>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:8px;">
        <button onclick="saveUpdates()">üíæ Enregistrer</button>
        <button onclick="loadUpdates()">‚Üª Recharger</button>
      </div>
    </div>
  </div>

  <!-- Status Box (visible pour tous) -->
  <div id="statusBox" class="status-container">
    <div class="loading">Chargement du statut...</div>
  </div>

  <div class="auto-refresh">Actualisation automatique toutes les 30 secondes</div>

  <script>
    const statuses = {
      online: {
        tag: "üü¢ En ligne",
        tagClass: "tag-online",
        title: "Syst√®me pleinement op√©rationnel",
        details: [
          "<strong>‚úî Tous les services</strong> sont accessibles sans restriction.",
          "Merci pour votre patience pendant la derni√®re intervention."
        ]
      },
      maintenance: {
        tag: "üõ† Maintenance",
        tagClass: "tag-maintenance",
        title: "Maintenance planifi√©e en cours",
        details: [
          "Certains services peuvent √™tre temporairement <strong>inaccessibles</strong>.",
          "Notre √©quipe effectue des mises √† jour pour am√©liorer la s√©curit√© et la stabilit√©.",
          "Merci de votre compr√©hension üôè"
        ]
      },
      offline: {
        tag: "üî¥ Hors ligne",
        tagClass: "tag-offline",
        title: "Service momentan√©ment indisponible",
        details: [
          "Un probl√®me technique emp√™che actuellement l'acc√®s aux services.",
          "Notre √©quipe est d√©j√† mobilis√©e pour r√©tablir la situation.",
          "<strong>Nous publierons un patch d√®s que possible.</strong>"
        ]
      },
      critical: {
        tag: "‚ö†Ô∏è Probl√®me critique",
        tagClass: "tag-critical",
        title: "Incident majeur en cours",
        details: [
          "Nous rencontrons actuellement un <strong>incident critique</strong> affectant plusieurs services.",
          "Les performances et l'acc√®s sont fortement d√©grad√©s.",
          "Notre √©quipe traite le probl√®me en priorit√© absolue.",
          "Merci de rester inform√© via cette page pour les prochaines mises √† jour."
        ]
      }
    };

    let isAdmin = false;

    // V√©rifier si c'est l'admin (tu peux changer cette logique)
    function checkAdmin() {
      const adminKey = prompt("Cl√© administrateur :");
      if (adminKey === "admin123") { // Change cette cl√© !
        isAdmin = true;
        document.getElementById("adminPanel").style.display = "block";
        document.getElementById("adminMessage").textContent = "Connect√© en tant qu'administrateur";
      }
    }

    // Fermer le panel admin
    function closeAdminPanel() {
      document.getElementById("adminPanel").style.display = "none";
      document.getElementById("adminMessage").textContent = "";
      isAdmin = false; // Reset admin status
      
      // Mettre √† jour le statut affich√© imm√©diatement
      loadStatus();
      
      // Afficher un message de confirmation temporaire
      const statusBox = document.getElementById("statusBox");
      const currentContent = statusBox.innerHTML;
      
      // Ajouter un message de confirmation en haut
      const confirmationMessage = `
        <div style="background: rgba(67, 184, 97, 0.2); border: 1px solid #43b861; color: #43b861; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center;">
          ‚úÖ Panel admin ferm√© - Statut mis √† jour
        </div>
        ${currentContent}
      `;
      
      statusBox.innerHTML = confirmationMessage;
      
      // Faire dispara√Ætre le message apr√®s 3 secondes
      setTimeout(() => {
        loadStatus(); // Recharger le statut final
      }, 3000);
    }

    // Charger le status depuis l'API
    async function loadStatus() {
      try {
        const response = await fetch('http://localhost:3001/api/maintenance/status');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        displayStatus(data.status, data.timestamp);
      } catch (error) {
        console.error('Erreur lors du chargement du status:', error);
        displayError("Impossible de charger le statut du service");
      }
    }

    // Afficher le status
    function displayStatus(statusType, timestamp) {
      const status = statuses[statusType];
      if (!status) {
        displayError("Status inconnu");
        return;
      }

      const box = document.getElementById("statusBox");
      const timeStr = timestamp ? new Date(timestamp).toLocaleString('fr-FR') : new Date().toLocaleString('fr-FR');

      box.innerHTML = `
        <div class="status-tag ${status.tagClass}">${status.tag}</div>
        <h1>${status.title}</h1>
        <p class="time-range">Derni√®re mise √† jour : ${timeStr}</p>
        <div class="details">
          ${status.details.map(d => `<p>${d}</p>`).join("")}
        </div>
        <div id="updatesView" class="updates-box" style="display:none;">
          <h3>üìù Nouveaut√©s</h3>
          <div id="updatesContent">Chargement des mises √† jour...</div>
        </div>
        <div class="status-footer">
          Propuls√© par Mythic Status ‚Ä¢ Evann
        </div>
      `;
      // Pr√©charger le texte des mises √† jour pour affichage rapide lors du clic
      preloadUpdatesView();
    }

    // Afficher une erreur
    function displayError(message) {
      const box = document.getElementById("statusBox");
      box.innerHTML = `
        <div class="error">${message}</div>
        <div class="status-footer">
          Propuls√© par Mythic Status ‚Ä¢ Evann
        </div>
      `;
    }

    // Mettre √† jour le status (admin seulement) - Via API
    async function updateStatus(statusType) {
      if (!isAdmin) return;

      try {
        const response = await fetch('http://localhost:3001/api/maintenance/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            status: statusType,
            timestamp: new Date().toISOString()
          })
        });

        if (response.ok) {
          document.getElementById("adminMessage").textContent = `Status mis √† jour : ${statusType}`;
          loadStatus(); // Recharger imm√©diatement
        } else {
          document.getElementById("adminMessage").textContent = "Erreur lors de la mise √† jour";
        }
      } catch (error) {
        console.error('Erreur:', error);
        document.getElementById("adminMessage").textContent = "Erreur de connexion √† l'API";
      }
    }

    // Auto-refresh toutes les 30 secondes
    setInterval(loadStatus, 30000);

    // Charger au d√©marrage
    window.onload = function() {
      loadStatus();
      
      // V√©rifier si admin au clic sur le logo ou avec un raccourci clavier
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'A') {
          e.preventDefault();
          checkAdmin();
        }
      });
    };

    // =====================
    // Updates (admin + public)
    // =====================
    async function loadUpdates() {
      if (!isAdmin) return;
      try {
        const res = await fetch('http://localhost:3001/api/maintenance/updates');
        const data = await res.json();
        document.getElementById('updatesText').value = data?.updates?.text || '';
        document.getElementById('adminMessage').textContent = 'Notes charg√©es';
      } catch {
        document.getElementById('adminMessage').textContent = 'Erreur chargement des notes';
      }
    }

    async function loadUpdatesView() {
      try {
        const res = await fetch('http://localhost:3001/api/maintenance/updates');
        const data = await res.json();
        const view = document.getElementById('updatesView');
        const content = document.getElementById('updatesContent');
        if (!view || !content) return;
        if (data?.updates?.enabled) {
          const formatted = formatUpdatesText(data.updates.text || '');
          content.innerHTML = formatted.html;
          // Responsive margin-top selon longueur du contenu
          const lines = formatted.count;
          const base = 12; // px
          const extra = Math.min(24, Math.floor(lines * 0.8));
          document.getElementById('updatesView').style.marginTop = (base + extra) + 'px';
          view.style.display = 'block';
        } else {
          view.style.display = 'none';
        }
      } catch {
        const content = document.getElementById('updatesContent');
        if (content) content.textContent = 'Impossible de charger les mises √† jour.';
      }
    }

    // Pr√©charge le contenu, sans afficher
    function preloadUpdatesView() { loadUpdatesView(); }

    function toggleUpdatesEditor() {
      if (!isAdmin) return;
      const el = document.getElementById('updatesEditor');
      el.style.display = el.style.display === 'none' ? 'block' : 'none';
      if (el.style.display === 'block') loadUpdates();
    }

    function toggleUpdatesView() {
      const view = document.getElementById('updatesView');
      if (!view) return;
      const showing = view.style.display !== 'none';
      if (showing) {
        view.style.display = 'none';
      } else {
        view.style.display = 'block';
        loadUpdatesView();
      }
    }

    async function saveUpdates() {
      if (!isAdmin) return;
      const text = document.getElementById('updatesText').value;
      try {
        const res = await fetch('http://localhost:3001/api/maintenance/updates', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const data = await res.json();
        if (data && data.success) {
          document.getElementById('adminMessage').textContent = 'Notes enregistr√©es';
          // Mettre √† jour la vue si elle est ouverte
          const view = document.getElementById('updatesView');
          if (view && view.style.display !== 'none') loadUpdatesView();
        } else {
          document.getElementById('adminMessage').textContent = '√âchec enregistrement';
        }
      } catch {
        document.getElementById('adminMessage').textContent = 'Erreur enregistrement';
      }
    }

    // Mise en forme moderne du texte des nouveaut√©s
    function formatUpdatesText(text) {
      const lines = (text || '').split(/\r?\n/).filter(l => l.trim().length > 0);
      if (lines.length === 0) return { html: '<div class="updates-subtitle">Aucune mise √† jour.</div>', count: 1 };

      let html = '';
      // Premi√®re ligne conserv√©e comme titre s'il commence par un emoji ou un mot cl√©
      const first = lines[0];
      html += `<div class="updates-subtitle">${escapeHtml(first)}</div>`;

      const items = lines.slice(1).map(l => l.replace(/^[-‚Ä¢\s]+/, '').trim());
      if (items.length) {
        html += '<ul class="updates-list">' + items.map(i => `<li>${escapeHtml(i)}</li>`).join('') + '</ul>';
      }
      return { html, count: Math.max(1, items.length) };
    }

    function escapeHtml(s) {
      return s.replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    async function toggleUpdatesEnabled(enabled) {
      if (!isAdmin) return;
      try {
        const res = await fetch('http://localhost:3001/api/maintenance/updates/toggle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });
        const data = await res.json();
        document.getElementById('adminMessage').textContent = data.success ? (enabled ? 'Mises √† jour activ√©es' : 'Mises √† jour d√©sactiv√©es') : '√âchec de l\'op√©ration';
        loadUpdatesView();
      } catch {
        document.getElementById('adminMessage').textContent = 'Erreur de communication';
      }
    }
  </script>

</body>
</html>