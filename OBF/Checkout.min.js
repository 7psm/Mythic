document.addEventListener("DOMContentLoaded",()=>{console.log("=== INITIALISATION PAGE CHECKOUT ===");const e=document.querySelectorAll(".payment-option"),t=document.querySelectorAll(".shipping-option"),o=document.querySelector(".cart-count"),n=document.querySelector(".checkout-form"),l=document.querySelector(".submit-button");console.log("Éléments trouvés:"),console.log("- Options de paiement:",e.length),console.log("- Options de livraison:",t.length),console.log("- Compteur panier:",o),console.log("- Bouton submit:",l);const r="checkout_secure_key_2024";function c(){try{const e=JSON.parse(localStorage.getItem("cart")||"[]").reduce((e,t)=>e+t.price*t.quantity,0);let t=0;const o=document.querySelector(".shipping-option.selected");if(o){const e=o.querySelector(".shipping-price");if(e){const o=e.textContent.trim();if(o.includes("€")){const e=o.match(/(\d+\.?\d*)/);e&&(t=parseFloat(e[1]))}}}const n=e+t;return console.log("Calcul total:",{subtotal:e,shippingCost:t,total:n}),n}catch(e){return console.error("Erreur calcul total:",e),0}}function a(){if(!l)return;const e=c(),t=e.toFixed(2);l.innerHTML=e>0?`Finaliser la Commande - ${t}€`:"Finaliser la Commande",console.log("Bouton mis à jour avec le total:",t+"€")}function s(){if(!n)return;const e=function(e){try{const t=JSON.stringify(e);return btoa(encodeURIComponent(t+r))}catch(e){return console.error("Erreur de chiffrement:",e),null}}({timestamp:(new Date).toISOString(),customerInfo:{name:document.getElementById("name")?.value||"",email:document.getElementById("email")?.value||"",phone:document.getElementById("phone")?.value||"",discord:document.getElementById("telegram")?.value||""},shippingInfo:{country:document.getElementById("country")?.value||"",address:document.getElementById("address")?.value||"",city:document.getElementById("city")?.value||"",postalCode:document.getElementById("postalCode")?.value||""},preferences:{shippingMethod:localStorage.getItem("selectedShippingMethod")||"",paymentMethod:localStorage.getItem("selectedPaymentMethod")||""}});e&&(localStorage.setItem("secureCheckoutData",e),console.log("Données du formulaire sauvegardées de manière sécurisée"))}function i(){const e=localStorage.getItem("secureCheckoutData");if(!e)return;const t=function(e){try{const t=decodeURIComponent(atob(e)).replace(r,"");return JSON.parse(t)}catch(e){return console.error("Erreur de déchiffrement:",e),null}}(e);if(t){if(console.log("Restauration des données du formulaire..."),t.customerInfo){const e=document.getElementById("name"),o=document.getElementById("email"),n=document.getElementById("phone"),l=document.getElementById("telegram");e&&(e.value=t.customerInfo.name||""),o&&(o.value=t.customerInfo.email||""),n&&(n.value=t.customerInfo.phone||""),l&&(l.value=t.customerInfo.discord||"")}if(t.shippingInfo){const e=document.getElementById("country"),o=document.getElementById("address"),n=document.getElementById("city"),l=document.getElementById("postalCode");e&&(e.value=t.shippingInfo.country||""),o&&(o.value=t.shippingInfo.address||""),n&&(n.value=t.shippingInfo.city||""),l&&(l.value=t.shippingInfo.postalCode||"")}}}function u(){if(o)try{const e=JSON.parse(localStorage.getItem("cart")||"[]").reduce((e,t)=>e+(t.quantity||0),0);e>0?(o.textContent=e,o.style.display="flex"):(o.textContent="0",o.style.display="flex"),console.log("Compteur panier mis à jour:",e),a()}catch(e){console.error("Erreur lors de la mise à jour du compteur panier:",e)}}function d(){u(),console.log("Initialisation des moyens de paiement - AUCUN par défaut"),e.forEach(e=>{e.classList.remove("selected")}),console.log("Aucun moyen de paiement sélectionné par défaut"),function(){console.log("Initialisation des modes de livraison - Gratuit par défaut"),t.forEach(e=>e.classList.remove("selected"));let e=!1;if(t.forEach(t=>{const o=t.querySelector(".shipping-price"),n=t.querySelector(".shipping-name");if(o&&n){const l=o.textContent.trim().toLowerCase(),r=n.textContent.trim();(l.includes("gratuit")||r.includes("Classique"))&&(t.classList.add("selected"),localStorage.setItem("selectedShippingMethod",r),e=!0,console.log("Livraison gratuite sélectionnée par défaut:",r))}}),!e&&t.length>0){t[0].classList.add("selected");const e=t[0].querySelector(".shipping-name");e&&(localStorage.setItem("selectedShippingMethod",e.textContent.trim()),console.log("Première option de livraison sélectionnée par défaut"))}a()}(),e.forEach((t,o)=>{t.addEventListener("click",n=>{n.preventDefault();const l=t.querySelector(".payment-method-name");if(!l)return void console.error(`Élément .payment-method-name non trouvé dans l'option ${o}`);const r=l.textContent.trim();console.log("Moyen de paiement sélectionné:",r),e.forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),localStorage.setItem("selectedPaymentMethod",r),console.log("Moyen de paiement sauvegardé:",r),s()})}),t.forEach((e,o)=>{e.addEventListener("click",n=>{n.preventDefault();const l=e.querySelector(".shipping-name");if(!l)return void console.error(`Élément .shipping-name non trouvé dans l'option ${o}`);const r=l.textContent.trim();console.log("Mode de livraison sélectionné:",r),t.forEach(e=>e.classList.remove("selected")),e.classList.add("selected"),localStorage.setItem("selectedShippingMethod",r),console.log("Mode de livraison sauvegardé:",r),a(),s()})}),n&&l&&(l.onclick=function(e){if(e.preventDefault(),console.log("=== VALIDATION DU FORMULAIRE ==="),0===JSON.parse(localStorage.getItem("cart")||"[]").length)return void alert("Votre panier est vide. Ajoutez des articles avant de finaliser votre commande.");const t=n.querySelectorAll("input[required]");let o=!0;if(t.forEach(e=>{e.value.trim()?e.style.borderColor="":(e.style.borderColor="#ff4444",o=!1)}),document.querySelector(".payment-option.selected")||(alert("Veuillez sélectionner un moyen de paiement."),o=!1),document.querySelector(".shipping-option.selected")||(alert("Veuillez sélectionner un mode de livraison."),o=!1),o){console.log("Formulaire valide, finalisation de la commande..."),s();const e="CMD-"+Date.now().toString().slice(-8);console.log("Numéro de commande généré:",e),window.location.href="./Confirmation.html?order="+e}else console.log("Formulaire invalide"),alert("Veuillez remplir tous les champs obligatoires et sélectionner un moyen de paiement.")}),i(),n&&n.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"]').forEach(e=>{let t;e.addEventListener("blur",()=>{s()}),e.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{s()},1e3)})}),a(),console.log("=== INITIALISATION TERMINÉE ==="),console.log("- Moyens de paiement: AUCUN sélectionné par défaut"),console.log("- Mode de livraison: GRATUIT sélectionné par défaut"),console.log("- Données cryptées et sauvegardées automatiquement"),console.log("- Bouton mis à jour avec le prix total")}d(),window.checkoutUtils={updateCartCount:u,initialize:d,clearSecureData:function(){localStorage.removeItem("secureCheckoutData"),localStorage.removeItem("selectedPaymentMethod"),localStorage.removeItem("selectedShippingMethod"),console.log("Données sécurisées supprimées")},saveFormDataSecurely:s,updateSubmitButtonText:a,calculateOrderTotal:c}});