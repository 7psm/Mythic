document.addEventListener("DOMContentLoaded",function(){import("../Utils/discordNotification.js").then(e=>{window.sendOrderToDiscord=e.sendOrderToDiscord});let e=!1,o=!1,t=!1,n="",r={};const i=document.getElementById("submit-order"),c=document.getElementById("screenshot-modal"),d=document.getElementById("vendor-modal"),a=document.getElementById("not-yet-btn"),s=document.getElementById("screenshot-taken-btn"),l=document.getElementById("continue-to-vendor"),m=document.getElementById("confirmation-modal"),u=document.getElementById("confirmation-ok-btn");function g(){if(console.log("=== INITIALISATION PAGE CONFIRMATION ==="),p(),!r.orderNumber)return console.log("Pas de donn√©es de commande, redirection vers l'accueil"),void(window.location.href="/index.html");!function(){console.log("Population des donn√©es sur la page...");const e=document.getElementById("order-number"),o=document.getElementById("order-date"),t=document.getElementById("customer-name");e&&(e.textContent=r.orderNumber);o&&(o.textContent=function(e){if(!e)return(new Date).toLocaleDateString("fr-FR");return new Date(e).toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}(r.orderDate));t&&(t.textContent=r.name);document.getElementById("contact-name").textContent=r.name,document.getElementById("contact-email").textContent=r.email,document.getElementById("contact-phone").textContent=r.phoneNumber,document.getElementById("contact-discord").textContent=r.discord,document.getElementById("shipping-address").textContent=r.address,document.getElementById("shipping-city").textContent=r.city,document.getElementById("shipping-country").textContent=r.country,document.getElementById("shipping-postal").textContent=r.postalCode,document.getElementById("shipping-method").textContent=r.shippingMethod.name,document.getElementById("shipping-delivery").textContent=r.shippingMethod.delivery,document.getElementById("payment-method").textContent=r.paymentMethod,function(){const e=document.getElementById("order-items");if(!e)return;e.innerHTML="",r.orderItems.forEach(o=>{const t=o.price*o.quantity,n=document.createElement("div");n.className="order-item",n.innerHTML=`\n        <div class="item-name">\n          ${o.name}\n          <span>x${o.quantity}</span>\n        </div>\n        <div class="item-price">‚Ç¨${t.toFixed(2)}</div>\n      `,e.appendChild(n)})}(),function(){const e=r.orderItems.reduce((e,o)=>e+o.price*o.quantity,0),o=r.shippingMethod.price||0,t=e+o;document.getElementById("subtotal").textContent=`‚Ç¨${e.toFixed(2)}`,document.getElementById("shipping-cost").textContent=0===o?"Gratuit":`‚Ç¨${o.toFixed(2)}`,document.getElementById("total-cost").textContent=`‚Ç¨${t.toFixed(2)}`,console.log("Totaux calcul√©s:",{subtotal:e,shippingCost:o,total:t})}(),console.log("Population des donn√©es termin√©e")}(),function(){i?i.addEventListener("click",y):console.error("‚ùå Bouton submit non trouv√©");a?a.addEventListener("click",()=>{console.log('Clic sur "Pas encore"'),C(c)}):console.error('‚ùå Bouton "Pas encore" non trouv√©');s?s.addEventListener("click",f):console.error('‚ùå Bouton "J\'ai pris une capture" non trouv√©');l?l.addEventListener("click",I):console.error('‚ùå Bouton "Continuer vers le Vendeur" non trouv√©');u?u.addEventListener("click",()=>{window.location.href="/index.html"}):console.error('‚ùå Bouton "OK Confirmation" non trouv√©');[c,d].forEach(e=>{e&&e.addEventListener("click",function(o){o.target===e&&(console.log("Clic √† l'ext√©rieur du modal, fermeture..."),C(e))})}),console.log("üîç Debug - √âl√©ments modales:"),console.log("Screenshot modal:",c?"Trouv√©":"Non trouv√©"),console.log("Vendor modal:",d?"Trouv√©":"Non trouv√©"),console.log("Event listeners configur√©s")}(),setTimeout(()=>{i&&(i.disabled=!1,i.textContent="Soumettre la Commande")},500),console.log("=== INITIALISATION TERMIN√âE ===")}function p(){try{const e=new URLSearchParams(window.location.search).get("order"),o=localStorage.getItem("secureCheckoutData");let t=null;o&&(t=function(e){try{const o=decodeURIComponent(atob(e)).replace("checkout_secure_key_2024","");return JSON.parse(o)}catch(e){return console.error("Erreur de d√©chiffrement:",e),null}}(o));const n=JSON.parse(localStorage.getItem("cart")||"[]"),i=localStorage.getItem("selectedShippingMethod")||"Livraison Standard",c=localStorage.getItem("selectedPaymentMethod")||"PayPal";r={orderNumber:e||h(),orderDate:(new Date).toISOString(),name:t?.customerInfo?.name||"Client",email:t?.customerInfo?.email||"Non renseign√©",phoneNumber:t?.customerInfo?.phone||"Non renseign√©",discord:t?.customerInfo?.discord||"Non renseign√©",address:t?.shippingInfo?.address||"Non renseign√©",city:t?.shippingInfo?.city||"Non renseign√©",country:t?.shippingInfo?.country||"Non renseign√©",postalCode:t?.shippingInfo?.postalCode||"Non renseign√©",orderItems:n,shippingMethod:{name:i,price:i.includes("Express")?2.5:0,delivery:i.includes("Express")?"15-20min":"6-12h"},paymentMethod:c},console.log("Donn√©es de commande charg√©es:",r)}catch(e){console.error("Erreur lors du chargement des donn√©es:",e),r={orderNumber:null}}}function h(){return`PM-${Date.now().toString().slice(-8)}`}function y(e){e.preventDefault(),t?console.log("D√©j√† en cours, clic ignor√©."):o?(console.log("Capture OK, envoi commande"),n="Incognito Market",console.log("Affichage du modal vendeur..."),async function(){console.log("Soumission de la commande..."),v(!0);try{const e=await fetch("http://localhost:3001/api/order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});return!!(await e.json()).success&&(console.log("Commande enregistr√©e c√¥t√© serveur"),!0)}catch(e){return!1}finally{v(!1)}}().then(()=>{E(d)})):(console.log("Demande capture d'√©cran"),E(c))}function f(){console.log("Capture d'√©cran confirm√©e"),o=!0,C(c),console.log("Capture d'√©cran confirm√©e, retour √† la page principale")}function I(){console.log("Redirection vers Discord du vendeur:",n),localStorage.setItem("orderCompleted",JSON.stringify({orderNumber:r.orderNumber,completedAt:(new Date).toISOString(),vendor:n})),console.log("R√©initialisation du panier..."),localStorage.removeItem("cart"),localStorage.removeItem("propMoneyCart"),localStorage.removeItem("secureCheckoutData"),localStorage.removeItem("selectedShippingMethod"),localStorage.removeItem("selectedPaymentMethod");const e=document.querySelector(".cart-count");e&&(e.textContent="0",e.style.display="flex"),console.log("‚úÖ Panier r√©initialis√© avec succ√®s");const o="https://discord.gg/beC8cFZaXH";console.log("Ouverture de Discord:",o),window.open(o,"_blank"),C(d),setTimeout(()=>{console.log("üéâ Ouverture du modal de remerciement"),E(m)},1e3)}function v(e){t=e,i&&(i.disabled=e,i.textContent=e?"Envoi en cours...":"Soumettre la Commande")}function E(o){o?(console.log("Ouverture du modal:",o.id),o.classList.add("active"),e=!0):console.error("Modal non trouv√© pour ouverture")}function C(o){o?(console.log("Fermeture du modal:",o.id),o.classList.remove("active"),e=!1):console.error("Modal non trouv√© pour fermeture")}window.confirmationPage={orderData:r,initialize:g,handleSubmitClick:y,confirmScreenshotTaken:f,openVendorDiscord:I,loadOrderData:p,sendOrderToDiscord:async function(e){try{console.log("Envoi des donn√©es de commande vers Discord...");const o=e=>"string"!=typeof e?String(e):e.replace(/[`*_~|\\]/g,"\\$&").replace(/@/g,"@‚Äã").trim().substring(0,1e3),t={...e,name:o(e.name||""),email:o(e.email||""),phoneNumber:o(e.phoneNumber||""),discord:o(e.discord||""),address:o(e.address||""),city:o(e.city||""),postalCode:o(e.postalCode||""),country:o(e.country||""),orderItems:(e.orderItems||[]).map(e=>({...e,name:o(e.name||""),price:parseFloat(e.price)||0,quantity:parseInt(e.quantity)||0}))},n=t.orderItems.reduce((e,o)=>e+o.price*o.quantity,0),r=parseFloat(t.shippingMethod?.price)||0,i=n+r,c=e=>{if(!e)return"N/A";try{const o=new Date(e);return isNaN(o.getTime())?"N/A":o.toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return"N/A"}},d=e=>0===e?"GRATUIT":`‚Ç¨${e.toFixed(2)}`,a=t.orderItems.slice(0,10).map(e=>`‚Ä¢ **${e.name}** x${e.quantity} - ‚Ç¨${(e.price*e.quantity).toFixed(2)}`).join("\n"),s={title:"üõí NOUVELLE COMMANDE RE√áUE",color:65280,timestamp:(new Date).toISOString(),fields:[{name:"üìã Informations de commande",value:`**Num√©ro:** ${t.orderNumber||"N/A"}\n**Date:** ${c(t.orderDate)}`,inline:!1},{name:"üë§ Informations client",value:[`**Nom:** ${t.name}`,`**Email:** ${t.email}`,t.phoneNumber?`**T√©l√©phone:** ${t.phoneNumber}`:null,t.discord?`**Discord:** ${t.discord}`:null].filter(Boolean).join("\n"),inline:!0},{name:"üìç Adresse de livraison",value:[`**Adresse:** ${t.address}`,`**Ville:** ${t.city}`,`**Code postal:** ${t.postalCode}`,`**Pays:** ${t.country}`].join("\n"),inline:!0},{name:"üöö M√©thode d'exp√©dition",value:[`**Transporteur:** ${t.shippingMethod?.name||"N/A"}`,`**D√©lai:** ${t.shippingMethod?.delivery||"N/A"}`,`**Co√ªt:** ${d(r)}`].join("\n"),inline:!1},{name:"üõçÔ∏è Articles command√©s",value:a||"Aucun article",inline:!1},{name:"üí∞ R√©capitulatif",value:[`**Sous-total:** ‚Ç¨${n.toFixed(2)}`,`**Exp√©dition:** ${d(r)} (${t.shippingMethod?.name||"N/A"})`,`**Total:** ‚Ç¨${i.toFixed(2)}`,t.paymentMethod?`**Paiement:** ${t.paymentMethod}`:null].filter(Boolean).join("\n"),inline:!1}],footer:{text:"Syst√®me de notification automatique",icon_url:"https://cdn.discordapp.com/embed/avatars/0.png"}},l=window.location.origin,m=await fetch(`${l}/.netlify/functions/discord-webhook`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({embed:s,userId:"725623395294773308",channelId:"1406563826425397288"})});if(!m.ok){const e=await m.json().catch(()=>({}));throw new Error(`HTTP ${m.status}: ${e.error||"Unknown error"}`)}const u=await m.json();return u.success?(console.log("‚úÖ Discord notification sent successfully:",u),!0):(console.error("‚ùå Discord notification failed:",u),!1)}catch(e){return console.error("Erreur lors de l'envoi vers Discord:",e.message),!1}}},localStorage.clear(),g()});