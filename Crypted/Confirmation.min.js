const API_URL="http://localhost:3001";!function(){try{const e=window.location.origin+window.location.pathname;window.history.replaceState({},document.title,e),console.log("🔧 URL nettoyée immédiatement:",e)}catch(e){console.log("⚠️ Impossible de nettoyer l'URL:",e)}}(),document.addEventListener("DOMContentLoaded",function(){let e=!1,t=!1,n=".uwg9",o={};const i={submitButton:document.getElementById("submit-order"),screenshotModal:document.getElementById("screenshot-modal"),vendorModal:document.getElementById("vendor-modal"),thankYouModal:document.getElementById("confirmation-modal"),notYetBtn:document.getElementById("not-yet-btn"),screenshotTakenBtn:document.getElementById("screenshot-taken-btn"),continueToVendorBtn:document.getElementById("continue-to-vendor"),confirmationOkBtn:document.getElementById("confirmation-ok-btn")};function c(e){const t=(e||"").toLowerCase();return t.includes("express")?"2-4H":(t.includes("standard")||t.includes("classique"),"6-12H")}function a(){return`PM-${Math.floor(1e5+9e5*Math.random())}-${Math.floor(1e3+9e3*Math.random())}`}function r(t){t.preventDefault(),e?function(){u(i.vendorModal);const e=document.querySelector('.vendor-option[data-vendor=".uwg9"]');e&&e.classList.add("selected")}():u(i.screenshotModal)}function d(){e=!0,p(i.screenshotModal),i.submitButton&&(i.submitButton.textContent="Finaliser la commande",i.submitButton.style.backgroundColor="#28a745")}function s(){n=".uwg9",p(i.vendorModal),i.submitButton&&(i.submitButton.textContent="Traitement en cours...",i.submitButton.disabled=!0,i.submitButton.style.backgroundColor="#ffc107"),setTimeout(async()=>{await async function(){if(t)return!1;t=!0;try{const e={...o,selectedVendor:n,submittedAt:(new Date).toISOString()},t=await fetch(`${API_URL}/api/order`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)}),i=await t.json();return i.success&&i.order?(console.log("📧 Envoi de l'email de confirmation..."),await m(e)):(console.log("📧 Envoi direct de l'email..."),await m(e)),i.success}catch(e){return console.error("Erreur serveur:",e),!1}finally{t=!1}}();try{window.open("https://discord.gg/beC8cFZaXH","_blank")}catch{}setTimeout(()=>u(i.thankYouModal),500)},2e3)}async function m(e){try{const t={customerEmail:e.email,customerName:e.name,orderNumber:e.orderNumber,totalAmount:l(e.orderItems,e.shippingMethod.price),items:e.orderItems.map(e=>({name:e.name,quantity:e.quantity,price:e.price})),shippingMethod:e.shippingMethod.name,shippingCost:e.shippingMethod.price,paymentMethod:e.paymentMethod},n=await fetch(`${API_URL}/api/send-order-email`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),o=await n.json();o.success?(console.log("✅ Email de confirmation envoyé avec succès !"),console.log("📧 Message ID:",o.messageId)):console.error("❌ Échec de l'envoi de l'email:",o.error)}catch(e){console.error("❌ Erreur lors de l'envoi de l'email:",e)}}function l(e,t=0){return(e.reduce((e,t)=>e+t.price*t.quantity,0)+t).toFixed(2)}function u(e){e&&(e.style.display="flex",e.classList.add("active"))}function p(e){e&&(e.style.display="none",e.classList.remove("active"))}console.log("🚀 Initialisation de la page confirmation"),function(){const e=localStorage.getItem("secureCheckoutData"),t=e?function(e){try{const t=decodeURIComponent(atob(e)).replace("checkout_secure_key_2024","");return JSON.parse(t)}catch{return null}}(e):null,n=JSON.parse(localStorage.getItem("cart")||"[]"),i=localStorage.getItem("selectedShippingMethod")||"Livraison Standard",r=localStorage.getItem("selectedPaymentMethod")||"PayPal";o={orderNumber:a(),orderDate:(new Date).toISOString(),name:t?.customerInfo?.name||"Client",email:t?.customerInfo?.email||"Non renseigné",phoneNumber:t?.customerInfo?.phone||"Non renseigné",discord:t?.customerInfo?.discord||"Non renseigné",address:t?.shippingInfo?.address||"Non renseigné",city:t?.shippingInfo?.city||"Non renseigné",country:t?.shippingInfo?.country||"Non renseigné",postalCode:t?.shippingInfo?.postalCode||"Non renseigné",orderItems:n,shippingMethod:{name:i,price:i.includes("Express")?2.5:0,delivery:c(i)},paymentMethod:r}}(),function(){const e={orderNumber:document.getElementById("order-number"),orderDate:document.getElementById("order-date"),customerName:document.getElementById("customer-name"),contactName:document.getElementById("contact-name"),contactEmail:document.getElementById("contact-email"),contactPhone:document.getElementById("contact-phone"),contactDiscord:document.getElementById("contact-discord"),shippingAddress:document.getElementById("shipping-address"),shippingCity:document.getElementById("shipping-city"),shippingCountry:document.getElementById("shipping-country"),shippingPostal:document.getElementById("shipping-postal"),shippingMethod:document.getElementById("shipping-method"),shippingDelivery:document.getElementById("shipping-delivery"),paymentMethod:document.getElementById("payment-method")};e.orderNumber&&(e.orderNumber.textContent=o.orderNumber),e.orderDate&&(e.orderDate.textContent=new Date(o.orderDate).toLocaleDateString("fr-FR")),e.customerName&&(e.customerName.textContent=o.name),e.contactName&&(e.contactName.textContent=o.name),e.contactEmail&&(e.contactEmail.textContent=o.email),e.contactPhone&&(e.contactPhone.textContent=o.phoneNumber),e.contactDiscord&&(e.contactDiscord.textContent=o.discord),e.shippingAddress&&(e.shippingAddress.textContent=o.address),e.shippingCity&&(e.shippingCity.textContent=o.city),e.shippingCountry&&(e.shippingCountry.textContent=o.country),e.shippingPostal&&(e.shippingPostal.textContent=o.postalCode),e.shippingMethod&&(e.shippingMethod.textContent=o.shippingMethod.name),e.shippingDelivery&&(e.shippingDelivery.textContent=o.shippingMethod.delivery),e.paymentMethod&&(e.paymentMethod.textContent=o.paymentMethod),function(){const e=document.getElementById("order-items");e&&(e.innerHTML="",o.orderItems.forEach(t=>{const n=document.createElement("div");n.className="order-item";const o=document.createElement("span");o.className="item-name",o.textContent=t.name;const i=document.createElement("span");i.textContent=` x${t.quantity||1}`,o.appendChild(i);const c=document.createElement("span");c.className="item-price",c.textContent=`€${t.price.toFixed(2)}`,n.appendChild(o),n.appendChild(c),e.appendChild(n)}))}(),function(){const e=o.orderItems.reduce((e,t)=>e+t.price*t.quantity,0),t=o.shippingMethod.price,n=e+t,i=document.getElementById("subtotal"),c=document.getElementById("shipping-cost"),a=document.getElementById("total-cost");i&&(i.textContent=`€${e.toFixed(2)}`),c&&(c.textContent=t>0?`€${t.toFixed(2)}`:"Gratuit"),a&&(a.textContent=`€${n.toFixed(2)}`)}()}(),i.submitButton&&i.submitButton.addEventListener("click",r),i.notYetBtn&&i.notYetBtn.addEventListener("click",()=>p(i.screenshotModal)),i.screenshotTakenBtn&&i.screenshotTakenBtn.addEventListener("click",d),i.continueToVendorBtn&&i.continueToVendorBtn.addEventListener("click",s),i.confirmationOkBtn&&i.confirmationOkBtn.addEventListener("click",()=>{localStorage.removeItem("cart"),localStorage.removeItem("checkoutData"),localStorage.removeItem("secureCheckoutData"),sessionStorage.removeItem("checkoutData"),window.location.href="/index.html"}),[i.screenshotModal,i.vendorModal,i.thankYouModal].forEach(e=>{e&&e.addEventListener("click",t=>{t.target===e&&p(e)})}),i.submitButton&&(i.submitButton.disabled=!1)});