document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll(".payment-option"),t=document.querySelectorAll(".shipping-option"),o=document.querySelector(".cart-count"),r=document.querySelector(".checkout-form"),n=document.querySelector(".submit-button"),l="checkout_secure_key_2024";function c(){const e=JSON.parse(localStorage.getItem("cart")||"[]").reduce((e,t)=>e+t.price*t.quantity,0);let t=0;const o=document.querySelector(".shipping-option.selected");if(o){const e=o.querySelector(".shipping-price")?.textContent.match(/(\d+\.?\d*)/);t=e?parseFloat(e[1]):0}return e+t}function a(){if(!n)return;const e=c();n.textContent=e>0?`Finaliser la Commande - ${e.toFixed(2)}€`:"Finaliser la Commande"}function i(){if(!r)return;const e={timestamp:(new Date).toISOString(),customerInfo:{name:r.querySelector("#name")?.value||"",email:r.querySelector("#email")?.value||"",phone:r.querySelector("#phone")?.value||"",discord:r.querySelector("#discord")?.value||""},shippingInfo:{country:r.querySelector("#country")?.value||"",address:r.querySelector("#address")?.value||"",city:r.querySelector("#city")?.value||"",postalCode:r.querySelector("#postalCode")?.value||""},preferences:{shippingMethod:localStorage.getItem("selectedShippingMethod")||"",paymentMethod:localStorage.getItem("selectedPaymentMethod")||""},cart:JSON.parse(localStorage.getItem("cart")||"[]"),total:c()},t=function(e){try{return btoa(encodeURIComponent(JSON.stringify(e)+l))}catch{return null}}(e);return t&&localStorage.setItem("secureCheckoutData",t),e}function s(e,t){e.forEach(o=>{o.addEventListener("click",r=>{r.preventDefault(),e.forEach(e=>e.classList.remove("selected")),o.classList.add("selected");const n=o.querySelector("span, .shipping-name, .payment-method-name")?.textContent.trim()||"";localStorage.setItem(t,n),i(),a()})})}!function(){if(!o)return;const e=JSON.parse(localStorage.getItem("cart")||"[]").reduce((e,t)=>e+(t.quantity||0),0);o.textContent=e,o.style.display="flex",a()}(),function(){e.forEach(e=>e.classList.remove("selected"));let o=!1;t.forEach(e=>{const t=e.querySelector(".shipping-price")?.textContent.toLowerCase()||"",r=e.querySelector(".shipping-name")?.textContent||"";!o&&t.includes("gratuit")&&(e.classList.add("selected"),localStorage.setItem("selectedShippingMethod",r),o=!0)})}(),s(e,"selectedPaymentMethod"),s(t,"selectedShippingMethod"),r&&n&&n.addEventListener("click",async e=>{if(e.preventDefault(),0===JSON.parse(localStorage.getItem("cart")||"[]").length)return void alert("Votre panier est vide !");let t=!0;if(r.querySelectorAll("input[required]").forEach(e=>{e.value.trim()?e.style.borderColor="":(e.style.borderColor="#ff4444",t=!1)}),document.querySelector(".payment-option.selected")||(alert("Veuillez sélectionner un moyen de paiement"),t=!1),document.querySelector(".shipping-option.selected")||(alert("Veuillez sélectionner une méthode de livraison"),t=!1),!t)return void alert("Veuillez remplir tous les champs obligatoires");const o=i();n.textContent="Traitement en cours...",n.disabled=!0;try{const e=await fetch("https://mythic-api.onrender.com/api/order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!e.ok)throw new Error(`Erreur serveur: ${e.status}`);{const t=await e.json();console.log("✅ Commande traitée avec succès:",t),localStorage.setItem("lastOrderId",t.order.id),n.textContent="Redirection...",setTimeout(()=>{window.location.href="/src/pages/Confirmation.html"},500)}}catch(e){console.error("❌ Erreur lors du traitement:",e),alert("Erreur lors du traitement de la commande. Veuillez réessayer."),n.textContent="Finaliser la Commande",n.disabled=!1}}),r&&r.querySelectorAll("input").forEach(e=>{let t;e.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(i,500)}),e.addEventListener("blur",i)}),console.log("=== INITIALISATION TERMINÉE ===")});