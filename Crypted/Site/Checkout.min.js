import{getDiscountCodes,encryptData,decryptData,updateCartCount,formatPrice}from"../utils.js";document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelectorAll(".payment-option"),e=document.querySelectorAll(".shipping-option"),o=document.querySelector("form"),n=document.getElementById("checkout-button-desktop"),a=document.getElementById("checkout-button"),i=document.getElementById("button-price"),r=document.getElementById("button-price-mobile"),c=document.getElementById("recap-items"),s={subtotalHT:document.getElementById("summary-subtotal-ht"),tva:document.getElementById("summary-tva"),totalTTC:document.getElementById("summary-total-ttc"),discountSection:document.getElementById("discount-section"),discountCodeName:document.getElementById("discount-code-name"),discountAmount:document.getElementById("discount-amount"),shipping:document.getElementById("summary-shipping"),totalWithoutDiscount:document.getElementById("total-without-discount"),totalWithDiscount:document.getElementById("total-with-discount"),totalOriginal:document.getElementById("summary-total-original"),totalCrossed:document.getElementById("summary-total-crossed"),totalDiscounted:document.getElementById("summary-total-discounted")};function saveFormDataSecurely(){if(!o)return null;const t=o.querySelector("#discord"),e=o.querySelector("#client-name"),n={timestamp:(new Date).toISOString(),customerInfo:{discord:t?.value||"",discordname:t?.value||"",name:e?.value||""},preferences:{shippingMethod:localStorage.getItem("selectedShippingMethod")||"",paymentMethod:localStorage.getItem("selectedPaymentMethod")||""},cart:JSON.parse(localStorage.getItem("cart")||"[]"),total:calculateOrderTotal()},a=encryptData(n);return a&&localStorage.setItem("secureCheckoutData",a),n}function calculateOrderTotal(){const t=JSON.parse(localStorage.getItem("cart")||"[]"),e=t.reduce((t,e)=>t+e.price*e.quantity,0),o=document.querySelector(".shipping-option.selected"),n=o&&parseFloat(o.dataset.price)||0;return e+n}function displayCartItems(){if(!c)return;const t=JSON.parse(localStorage.getItem("cart")||"[]");0!==t.length?c.innerHTML=t.map(t=>`\n      <div class="flex justify-between items-center text-sm mb-2 pb-2 border-b border-[rgba(255,255,255,0.05)]">\n        <div class="flex-1">\n          <span class="text-text-white">${t.name}</span>\n          <span class="text-text-gray ml-2">x${t.quantity}</span>\n        </div>\n        <span class="text-gold-primary font-semibold">${formatPrice(t.price*t.quantity)}</span>\n      </div>\n    `).join(""):c.innerHTML='<p class="text-text-gray text-sm text-center py-4">Votre panier est vide</p>'}function updateCheckoutSummary(){const t=JSON.parse(localStorage.getItem("cart")||"[]"),e=JSON.parse(localStorage.getItem("appliedDiscount")||"null"),o=t.reduce((t,e)=>t+e.price*e.quantity,0),n=.2*o,a=o+n;let c=0;e&&(c="percentage"===e.type?a*(e.value/100):e.value);const l=Math.max(0,a-c),d=document.querySelector(".shipping-option.selected"),u=d&&parseFloat(d.dataset.price)||0,m=l+u;s.subtotalHT&&(s.subtotalHT.textContent=formatPrice(o)),s.tva&&(s.tva.textContent=formatPrice(n)),s.totalTTC&&(s.totalTTC.textContent=formatPrice(a)),e&&c>0?s.discountSection&&(s.discountSection.classList.remove("hidden"),s.discountCodeName&&(s.discountCodeName.textContent=e.code||"Code promo"),s.discountAmount&&(s.discountAmount.textContent=`-${formatPrice(c)}`)):s.discountSection&&s.discountSection.classList.add("hidden"),s.shipping&&(s.shipping.textContent=u>0?formatPrice(u):"Gratuit"),e&&c>0?(s.totalWithoutDiscount&&s.totalWithoutDiscount.classList.add("hidden"),s.totalWithDiscount&&(s.totalWithDiscount.classList.remove("hidden"),s.totalCrossed&&(s.totalCrossed.textContent=formatPrice(a+u)),s.totalDiscounted&&(s.totalDiscounted.textContent=formatPrice(m)))):(s.totalWithoutDiscount&&(s.totalWithoutDiscount.classList.remove("hidden"),s.totalOriginal&&(s.totalOriginal.textContent=formatPrice(m))),s.totalWithDiscount&&s.totalWithDiscount.classList.add("hidden"));const p=t.length>0?`- ${formatPrice(m)}`:"";i&&(i.textContent=p),r&&(r.textContent=p)}function setupOptionListeners(t,e){t.forEach(o=>{o.addEventListener("click",n=>{n.preventDefault(),t.forEach(t=>t.classList.remove("selected")),o.classList.add("selected");const a=o.querySelector("span, .shipping-name, .payment-method-name")?.textContent.trim()||"";localStorage.setItem(e,a),saveFormDataSecurely(),updateCheckoutSummary()})})}function initializeSelections(){t.forEach(t=>t.classList.remove("selected")),e.forEach(t=>t.classList.remove("selected"))}function setupFormValidation(){if(!o)return void console.error("❌ Formulaire non trouvé");const handleSubmit=async t=>{t.preventDefault();const e=JSON.parse(localStorage.getItem("cart")||"[]");if(0===e.length)return void alert("Votre panier est vide !");let i=!0;o.querySelectorAll("input[required]").forEach(t=>{t.value.trim()?t.style.borderColor="":(t.style.borderColor="#ff4444",i=!1)}),document.querySelector(".payment-option.selected")||(alert("Veuillez sélectionner un moyen de paiement"),i=!1),document.querySelector(".shipping-option.selected")||(alert("Veuillez sélectionner une méthode de livraison"),i=!1),i?(saveFormDataSecurely(),n&&(n.textContent="Traitement en cours...",n.disabled=!0),a&&(a.textContent="Traitement en cours...",a.disabled=!0),setTimeout(()=>{window.location.href="/src/pages/Confirmation.html"},500)):alert("Veuillez remplir tous les champs obligatoires")};o.addEventListener("submit",handleSubmit),n&&n.addEventListener("click",handleSubmit),a&&a.addEventListener("click",handleSubmit)}function initialize(){updateCartCount(),displayCartItems(),initializeSelections(),setupOptionListeners(t,"selectedPaymentMethod"),setupOptionListeners(e,"selectedShippingMethod"),setupFormValidation(),o&&o.querySelectorAll("input").forEach(t=>{let e;t.addEventListener("input",()=>{clearTimeout(e),e=setTimeout(saveFormDataSecurely,500)}),t.addEventListener("blur",saveFormDataSecurely)}),updateCheckoutSummary()}e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(t=>{t.classList.remove("selected","bg-[rgba(212,175,55,0.1)]","border-[#d4af37]")}),t.classList.add("selected","bg-[rgba(212,175,55,0.1)]","border-[#d4af37]"),updateCheckoutSummary()})}),t.forEach(e=>{e.addEventListener("click",()=>{t.forEach(t=>{t.classList.remove("selected","bg-[rgba(212,175,55,0.1)]","border-[#d4af37]")}),e.classList.add("selected","bg-[rgba(212,175,55,0.1)]","border-[#d4af37]")})}),initialize()});