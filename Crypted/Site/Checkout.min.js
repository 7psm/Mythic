document.addEventListener("DOMContentLoaded",()=>{console.log("ðŸš€ Initialisation Checkout");const e=document.querySelectorAll(".payment-option"),t=document.querySelectorAll(".shipping-option"),o=document.querySelector(".cart-count"),n=document.querySelector("form"),c=document.getElementById("checkout-button-desktop"),i=document.getElementById("checkout-button"),s=document.getElementById("button-price"),a=document.getElementById("button-price-mobile"),r="checkout_secure_key_2024";function l(){if(!n)return;console.log("ðŸ’¾ Sauvegarde des donnÃ©es du formulaire"),console.log("Discord:",n.querySelector("#discord")?.value),console.log("Email:",n.querySelector("#email")?.value);const e={timestamp:(new Date).toISOString(),customerInfo:{email:n.querySelector("#email")?.value||"",discord:n.querySelector("#discord")?.value||"",discordname:n.querySelector("#discord")?.value||""},preferences:{shippingMethod:localStorage.getItem("selectedShippingMethod")||"",paymentMethod:localStorage.getItem("selectedPaymentMethod")||""},cart:JSON.parse(localStorage.getItem("cart")||"[]"),total:d()},t=function(e){try{return btoa(encodeURIComponent(JSON.stringify(e)+r))}catch{return null}}(e);return t&&(localStorage.setItem("secureCheckoutData",t),console.log("âœ… DonnÃ©es sauvegardÃ©es")),e}function d(){const e=JSON.parse(localStorage.getItem("cart")||"[]").reduce((e,t)=>e+t.price*t.quantity,0);let t=0;const o=document.querySelector(".shipping-option.selected");return o&&(t=parseFloat(o.dataset.price)||0),e+t}function u(){console.log("ðŸ’° Mise Ã  jour du rÃ©capitulatif");const e=JSON.parse(localStorage.getItem("cart")||"[]"),t=JSON.parse(localStorage.getItem("appliedDiscount")||"null"),o=e.reduce((e,t)=>e+t.price*t.quantity,0),n=.2*o,c=o+n;let i=0,r=c;t&&(i="percentage"===t.type?c*(t.value/100):t.value,r=Math.max(0,c-i));let l=0;const d=document.querySelector(".shipping-option.selected");d&&(l=parseFloat(d.dataset.price)||0);const u=r+l;console.log("ðŸ“Š DÃ©tails:",{subtotalHT:o.toFixed(2),tva:n.toFixed(2),totalTTC:c.toFixed(2),discount:i.toFixed(2),shipping:l.toFixed(2),final:u.toFixed(2)});const m=document.getElementById("summary-subtotal-ht");m&&(m.textContent=`â‚¬${o.toFixed(2)}`);const p=document.getElementById("summary-tva");p&&(p.textContent=`â‚¬${n.toFixed(2)}`);const f=document.getElementById("summary-total-ttc");f&&(f.textContent=`â‚¬${c.toFixed(2)}`);const g=document.getElementById("discount-section");if(t&&i>0){if(g){g.classList.remove("hidden");const e=document.getElementById("discount-code-name"),o=document.getElementById("discount-amount");e&&(e.textContent=t.code||"Code promo"),o&&(o.textContent=`-â‚¬${i.toFixed(2)}`)}}else g&&g.classList.add("hidden");const h=document.getElementById("summary-shipping");h&&(h.textContent=l>0?`â‚¬${l.toFixed(2)}`:"Gratuit");const b=document.getElementById("total-without-discount"),y=document.getElementById("total-with-discount");if(t&&i>0){if(b&&b.classList.add("hidden"),y){y.classList.remove("hidden");const e=document.getElementById("summary-total-crossed"),t=document.getElementById("summary-total-discounted");e&&(e.textContent=`â‚¬${(c+l).toFixed(2)}`),t&&(t.textContent=`â‚¬${u.toFixed(2)}`)}}else{if(b){b.classList.remove("hidden");const e=document.getElementById("summary-total-original");e&&(e.textContent=`â‚¬${u.toFixed(2)}`)}y&&y.classList.add("hidden")}if(e.length>0){const e=`- â‚¬${u.toFixed(2)}`;s&&(s.textContent=e),a&&(a.textContent=e)}else s&&(s.textContent=""),a&&(a.textContent="")}function m(e,t){e.forEach(o=>{o.addEventListener("click",n=>{n.preventDefault(),e.forEach(e=>e.classList.remove("selected")),o.classList.add("selected");const c=o.querySelector("span, .shipping-name, .payment-method-name")?.textContent.trim()||"";localStorage.setItem(t,c),l(),u()})})}t.forEach(e=>{e.addEventListener("click",()=>{t.forEach(e=>{e.classList.remove("selected","bg-[rgba(212,175,55,0.1)]","border-[#d4af37]")}),e.classList.add("selected","bg-[rgba(212,175,55,0.1)]","border-[#d4af37]"),u()})}),e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(e=>{e.classList.remove("selected","bg-[rgba(212,175,55,0.1)]","border-[#d4af37]")}),t.classList.add("selected","bg-[rgba(212,175,55,0.1)]","border-[#d4af37]")})}),function(){if(!o)return;const e=JSON.parse(localStorage.getItem("cart")||"[]").reduce((e,t)=>e+(t.quantity||0),0);o.textContent=e,o.style.display="flex"}(),function(){console.log("ðŸ›’ Affichage des articles du panier");const e=JSON.parse(localStorage.getItem("cart")||"[]"),t=document.getElementById("recap-items");if(t){if(0===e.length)return void(t.innerHTML='<p class="text-text-gray text-sm text-center py-4">Votre panier est vide</p>');t.innerHTML=e.map(e=>`\n        <div class="flex justify-between items-center text-sm mb-2 pb-2 border-b border-[rgba(255,255,255,0.05)]">\n          <div class="flex-1">\n            <span class="text-text-white">${e.name}</span>\n            <span class="text-text-gray ml-2">x${e.quantity}</span>\n          </div>\n          <span class="text-gold-primary font-semibold">â‚¬${(e.price*e.quantity).toFixed(2)}</span>\n        </div>\n      `).join(""),console.log("âœ… Articles affichÃ©s")}}(),e.forEach(e=>e.classList.remove("selected")),t.forEach(e=>e.classList.remove("selected")),m(e,"selectedPaymentMethod"),m(t,"selectedShippingMethod"),function(){if(!n)return void console.error("Formulaire non trouvÃ©");const e=async e=>{if(e.preventDefault(),0===JSON.parse(localStorage.getItem("cart")||"[]").length)return void alert("Votre panier est vide !");let t=!0;if(n.querySelectorAll("input[required]").forEach(e=>{e.value.trim()?e.style.borderColor="":(e.style.borderColor="#ff4444",t=!1)}),document.querySelector(".payment-option.selected")||(alert("Veuillez sÃ©lectionner un moyen de paiement"),t=!1),document.querySelector(".shipping-option.selected")||(alert("Veuillez sÃ©lectionner une mÃ©thode de livraison"),t=!1),!t)return void alert("Veuillez remplir tous les champs obligatoires");const o=l();console.log("ðŸ“¤ DonnÃ©es Ã  envoyer:",o),c&&(c.textContent="Traitement en cours...",c.disabled=!0),i&&(i.textContent="Traitement en cours...",i.disabled=!0);try{setTimeout(()=>{window.location.href="/src/pages/Confirmation.html"},500)}catch(e){console.error("âŒ Erreur:",e),alert("Erreur lors de la redirection."),c&&(c.textContent="Finaliser la Commande",c.disabled=!1),i&&(i.textContent="Finaliser la Commande",i.disabled=!1)}};c&&c.addEventListener("click",e),i&&i.addEventListener("click",e)}(),n&&n.querySelectorAll("input").forEach(e=>{let t;e.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(l,500)}),e.addEventListener("blur",l)}),u(),console.log("âœ… Initialisation terminÃ©e")});