import{getDiscountCodes,updateCartCount,formatPrice,calculateCartTotal}from"../utils.js";document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelector(".cart-items-list"),e=document.querySelector(".summary-subtotal"),n=document.querySelector(".summary-total-value"),o=document.querySelector(".empty-cart-message"),r=document.querySelector(".cart-summary-section"),i=(document.querySelector(".cart-count"),0);function readCart(){try{const t=localStorage.getItem("cart");return JSON.parse(t||"[]")}catch(t){return console.error("❌ Erreur lecture panier:",t),[]}}function writeCart(t){try{localStorage.setItem("cart",JSON.stringify(t))}catch(e){console.error("❌ Erreur écriture panier:",e)}}function createCartItemElement(t){const e=document.createElement("li");e.className="cart-item",e.dataset.id=t.id,e.dataset.price=t.price;const n=document.createElement("div");n.className="item-image";let o="";const r=t.name.toLowerCase();o=r.includes("nitro")?'<svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 2L3 14h8l-1 8 10-12h-8l1-8z" fill="#5865F2" stroke="#7289DA" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>':r.includes("boost")?'<svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C12 2 6 6 6 12C6 15 7 18 7 18L12 22L17 18C17 18 18 15 18 12C18 6 12 2 12 2Z" fill="#F093FB" stroke="#F5576C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="white"/></svg>':r.includes("avatar")||r.includes("décoration")?'<svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="#43E97B" stroke="#38F9D7" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>':r.includes("member")?'<svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="9" cy="7" r="4" fill="#FA709A" stroke="#FEE140" stroke-width="1.5"/><circle cx="15" cy="9" r="3" fill="#FA709A" stroke="#FEE140" stroke-width="1.5"/><path d="M3 18C3 15 5 13 9 13C13 13 15 15 15 18" stroke="#FA709A" stroke-width="1.5" stroke-linecap="round"/><path d="M15 18C15 16 16 14 19 14C21 14 22 15 22 17" stroke="#FEE140" stroke-width="1.5" stroke-linecap="round"/></svg>':'<svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" fill="#5865F2" stroke="#7289DA" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><polyline points="7.5 4.21 12 6.81 16.5 4.21" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><polyline points="7.5 19.79 7.5 14.6 3 12" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><polyline points="21 12 16.5 14.6 16.5 19.79" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><polyline points="3.27 6.96 12 12.01 20.73 6.96" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><line x1="12" y1="22.08" x2="12" y2="12" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',n.innerHTML=o,e.appendChild(n);const i=document.createElement("div");i.className="item-details";const a=document.createElement("div");a.className="item-name",a.textContent=t.name;const s=document.createElement("div");s.className="item-price",s.textContent=formatPrice(t.price);const c=document.createElement("div");c.className="quantity-control";const d=document.createElement("span");d.className="quantity-label",d.textContent="Quantité :";const l=document.createElement("div");l.className="quantity-buttons";const u=document.createElement("button");u.className="quantity-button quantity-decrease",t.quantity<=1&&(u.disabled=!0),u.textContent="-";const m=document.createElement("span");m.className="quantity-display",m.textContent=String(t.quantity);const p=document.createElement("button");p.className="quantity-button quantity-increase",p.textContent="+",l.appendChild(u),l.appendChild(m),l.appendChild(p),c.appendChild(d),c.appendChild(l),i.appendChild(a),i.appendChild(s),i.appendChild(c),e.appendChild(i);const y=document.createElement("div");y.className="item-actions";const C=document.createElement("div");C.className="item-total",C.textContent=formatPrice(t.price*t.quantity);const h=document.createElement("button");return h.className="remove-button",h.textContent="Supprimer",y.appendChild(C),y.appendChild(h),e.appendChild(y),e}function updateCartTotals(){if(!e||!n)return;const o=t?.querySelectorAll(".cart-item")||[];let r=0;o.forEach(t=>{const e=t.querySelector(".quantity-display"),n=t.querySelector(".item-total");if(e&&n){const o=parseInt(e.textContent)||0,i=parseFloat(t.dataset.price)||0,a=o*i;n.textContent=formatPrice(a),r+=a}}),e.textContent=formatPrice(r),n.textContent=formatPrice(r+i)}function checkIfCartEmpty(){const t=readCart();r&&(r.style.display="block"),o&&(o.style.display=0===t.length?"block":"none")}function loadCart(){if(!t)return;const e=readCart();for(;t.firstChild;)t.removeChild(t.firstChild);if(0===e.length)return checkIfCartEmpty(),updateCartTotals(),void updateCartCount();e.forEach(e=>{if(e.id&&e.name&&void 0!==e.price&&e.quantity){const n=createCartItemElement(e);t.appendChild(n)}}),updateCartTotals(),checkIfCartEmpty(),updateCartCount()}function removeItem(t){const e=t.dataset.id;let n=readCart();n=n.filter(t=>t.id.toString()!==e.toString()),writeCart(n),t.remove(),updateCartTotals(),checkIfCartEmpty(),updateCartCount()}function syncCartStorage(){if(!t)return;const e=[];t.querySelectorAll(".cart-item").forEach(t=>{const n=t.querySelector(".quantity-display"),o=t.querySelector(".item-name");n&&o&&e.push({id:t.dataset.id,name:o.textContent,price:parseFloat(t.dataset.price),image:"/public/logo.png",quantity:parseInt(n.textContent)||1})}),writeCart(e)}function clearCart(){confirm("Êtes-vous sûr de vouloir vider le panier ?")&&(writeCart([]),loadCart())}t&&t.addEventListener("click",t=>{const e=t.target;if(e.classList.contains("quantity-button")){const t=e.classList.contains("quantity-increase")||"+"===e.textContent.trim(),n=e.closest(".cart-item"),o=n?.querySelector(".quantity-display"),r=n?.querySelector(".quantity-decrease");if(!o)return;let i=parseInt(o.textContent)||1;if(!t&&i<=1)return;i=t?i+1:i-1,o.textContent=i,r&&(r.disabled=i<=1),updateCartTotals(),syncCartStorage(),updateCartCount()}if(e.classList.contains("remove-button")){const t=e.closest(".cart-item");t&&removeItem(t)}}),loadCart(),window.cartUtils={clearCart:clearCart,loadCart:loadCart,readCart:readCart}});let currentDiscount=null;function loadAppliedDiscount(){try{const t=localStorage.getItem("appliedDiscount");if(t){const e=JSON.parse(t);currentDiscount=e;const n=document.getElementById("discount-code"),o=document.getElementById("apply-discount"),r=document.getElementById("discount-applied"),i=document.getElementById("discount-info");n&&(n.disabled=!0),o&&(o.disabled=!0),r&&r.classList.remove("hidden"),i&&(i.textContent=`✓ Code "${e.code}" appliqué (${e.description})`),updatePrices()}}catch(t){console.error("❌ Erreur chargement code promo:",t)}}function updatePrices(){const t={subtotal:document.querySelector(".summary-subtotal"),tva:document.querySelector(".summary-tva"),total:document.querySelector(".summary-total-value"),discountedSection:document.querySelector(".summary-total-discounted"),originalPrice:document.querySelector(".summary-total-original"),newPrice:document.querySelector(".summary-total-new")};if(!t.subtotal)return;const e=(t.subtotal.textContent||t.subtotal.innerText).replace(/[€\s]/g,"").replace(",","."),n=parseFloat(e)||0,o=.2*n,r=n+o;if(t.tva&&(t.tva.textContent=formatPrice(o)),currentDiscount){const e="percentage"===currentDiscount.type?r*(currentDiscount.value/100):currentDiscount.value,n=Math.max(0,r-e);t.total&&t.total.classList.add("hidden"),t.discountedSection&&t.discountedSection.classList.remove("hidden"),t.originalPrice&&(t.originalPrice.textContent=formatPrice(r)),t.newPrice&&(t.newPrice.textContent=formatPrice(n))}else t.total&&t.total.classList.remove("hidden"),t.discountedSection&&t.discountedSection.classList.add("hidden"),t.total&&(t.total.textContent=formatPrice(r))}function showMessage(t,e=!1){const n=document.getElementById("discount-message");n&&(n.textContent=t,n.className="mt-2 text-sm "+(e?"text-red-400":"text-green-400"),n.classList.remove("hidden"))}function hideMessage(){document.getElementById("discount-message")?.classList.add("hidden")}function applyDiscount(){const t=document.getElementById("discount-code"),e=t?.value.trim().toUpperCase();if(!e)return void showMessage("⚠️ Veuillez entrer un code",!0);const n=getDiscountCodes();if(n[e]){currentDiscount={code:e,...n[e]},saveDiscountToStorage();const o=document.getElementById("discount-info"),r=document.getElementById("discount-applied");o&&(o.textContent=`✓ Code "${e}" appliqué (${currentDiscount.description})`),r&&r.classList.remove("hidden"),t&&(t.value="",t.disabled=!0);const i=document.getElementById("apply-discount");i&&(i.disabled=!0),hideMessage(),updatePrices(),showMessage(`✓ Code "${e}" appliqué avec succès!`,!1)}else showMessage("❌ Code invalide",!0)}function removeDiscount(){currentDiscount=null,localStorage.removeItem("appliedDiscount");const t=document.getElementById("discount-code");t&&(t.disabled=!1,t.value="");const e=document.getElementById("apply-discount");e&&(e.disabled=!1);const n=document.getElementById("discount-applied");n&&n.classList.add("hidden"),hideMessage(),updatePrices()}function saveDiscountToStorage(){currentDiscount?localStorage.setItem("appliedDiscount",JSON.stringify(currentDiscount)):localStorage.removeItem("appliedDiscount")}document.addEventListener("DOMContentLoaded",function(){window.addEventListener("storage",function(t){if("discountCodes"===t.key){getDiscountCodes();const e=t.oldValue?JSON.parse(t.oldValue):{},n=t.newValue?JSON.parse(t.newValue):{},o=Object.keys(n).filter(t=>!e[t]);o.length>0&&(showMessage(`✨ Nouveau code disponible : ${o.join(", ")}`,!1),setTimeout(hideMessage,5e3))}"appliedDiscount"===t.key&&loadAppliedDiscount()}),loadAppliedDiscount(),document.getElementById("apply-discount")?.addEventListener("click",applyDiscount),document.getElementById("remove-discount")?.addEventListener("click",removeDiscount),document.getElementById("discount-code")?.addEventListener("keypress",function(t){"Enter"===t.key&&(t.preventDefault(),applyDiscount())});const t=document.querySelector(".summary-subtotal");if(t){const e=new MutationObserver(updatePrices);e.observe(t,{childList:!0,characterData:!0,subtree:!0})}const e=document.querySelector(".cart-items-list");if(e){const t=new MutationObserver(updatePrices);t.observe(e,{childList:!0,subtree:!0})}setTimeout(updatePrices,300)});