const starsContainer=document.getElementById("stars");for(let e=0;e<50;e++){const e=document.createElement("div");e.className="star",e.style.width=3*Math.random()+"px",e.style.height=e.style.width,e.style.left=100*Math.random()+"%",e.style.top=100*Math.random()+"%",e.style.animationDelay=2*Math.random()+"s",starsContainer.appendChild(e)}const PASSWORD_HASH="d3d650c1db24815e0d97bf3219577bd2a67f3561b85ed0677dc11d0a70cc781b",MAX_ATTEMPTS=5,LOCKOUT_DURATION=9e5,SESSION_DURATION=72e5;function getSecurityData(){try{const e=localStorage.getItem("adminSecurity");return e?JSON.parse(e):{attempts:0,lockoutUntil:null,sessionExpiry:null}}catch{return{attempts:0,lockoutUntil:null,sessionExpiry:null}}}function saveSecurityData(e){localStorage.setItem("adminSecurity",JSON.stringify(e))}async function hashPassword(e){const t=new TextEncoder,s=t.encode(e),n=await crypto.subtle.digest("SHA-256",s),o=Array.from(new Uint8Array(n));return o.map(e=>e.toString(16).padStart(2,"0")).join("")}function isLockedOut(){const e=getSecurityData();if(e.lockoutUntil){const t=Date.now();if(t<e.lockoutUntil){const s=Math.ceil((e.lockoutUntil-t)/6e4);return s}return e.lockoutUntil=null,e.attempts=0,saveSecurityData(e),!1}return!1}function isSessionValid(){const e=getSecurityData();return!!e.sessionExpiry&&Date.now()<e.sessionExpiry}function createSession(){const e=getSecurityData();e.sessionExpiry=Date.now()+SESSION_DURATION,e.attempts=0,e.lockoutUntil=null,saveSecurityData(e)}function destroySession(){const e=getSecurityData();e.sessionExpiry=null,saveSecurityData(e)}async function checkPassword(){const e=document.getElementById("password-input"),t=document.getElementById("password-error"),s=e.value,n=isLockedOut();if(!1!==n)return t.textContent=`üîí Trop de tentatives. R√©essayez dans ${n} minute(s).`,t.classList.remove("hidden"),void(e.value="");const o=await hashPassword(s),r=getSecurityData();if(o===PASSWORD_HASH)console.log("‚úÖ Authentification r√©ussie"),createSession(),document.getElementById("password-modal").classList.add("hidden"),document.getElementById("error-page").classList.add("hidden"),document.getElementById("admin-panel").style.display="block",loadCodes(),loadVersionHistory(),updateStatsDisplay(),e.value="",t.classList.add("hidden"),startSessionTimer();else{console.log("‚ùå Tentative √©chou√©e"),r.attempts++;const s=MAX_ATTEMPTS-r.attempts;r.attempts>=MAX_ATTEMPTS?(r.lockoutUntil=Date.now()+LOCKOUT_DURATION,saveSecurityData(r),t.textContent=`üîí Compte verrouill√© pour 15 minutes apr√®s ${MAX_ATTEMPTS} tentatives.`,console.warn("üîí Compte verrouill√© pour 15 minutes")):(saveSecurityData(r),t.textContent=`‚ùå Mot de passe incorrect (${s} tentative(s) restante(s))`),t.classList.remove("hidden"),e.value=""}}document.addEventListener("keydown",e=>{e.ctrlKey&&e.shiftKey&&"F"===e.key&&(e.preventDefault(),isSessionValid()?(document.getElementById("error-page").classList.add("hidden"),document.getElementById("admin-panel").style.display="block",loadCodes(),loadVersionHistory(),updateStatsDisplay()):(document.getElementById("password-modal").classList.remove("hidden"),document.getElementById("password-input").focus()))}),document.getElementById("password-input")?.addEventListener("keypress",e=>{"Enter"===e.key&&checkPassword()});let sessionTimer=null;function startSessionTimer(){sessionTimer&&clearTimeout(sessionTimer),updateSessionIndicator(),sessionTimer=setTimeout(()=>{console.warn("‚è±Ô∏è Session expir√©e"),logout(),alert("üîí Votre session a expir√© pour des raisons de s√©curit√©. Veuillez vous reconnecter.")},SESSION_DURATION)}function updateSessionIndicator(){const e=getSecurityData();if(!e.sessionExpiry)return;const t=e.sessionExpiry-Date.now(),s=Math.floor(t/36e5),n=Math.floor(t%36e5/6e4);let o=document.getElementById("session-indicator");if(!o){o=document.createElement("div"),o.id="session-indicator",o.className="glass px-3 py-1 rounded-lg text-xs text-gray-400 ml-4";const e=document.querySelector("#admin-panel .flex.items-center.gap-4");e&&e.appendChild(o)}t>0&&(o.textContent=`‚è±Ô∏è Session: ${s}h ${n}m`,o.classList.remove("text-red-400"),o.classList.add("text-gray-400")),setTimeout(updateSessionIndicator,6e4)}function logout(){console.log("üö™ D√©connexion"),destroySession(),sessionTimer&&(clearTimeout(sessionTimer),sessionTimer=null),document.getElementById("admin-panel").style.display="none",document.getElementById("error-page").classList.remove("hidden"),document.getElementById("password-input").value="",document.getElementById("password-error").classList.add("hidden")}function switchTab(e){document.querySelectorAll(".tab-btn").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(e=>e.classList.add("hidden")),"codes"===e?(document.querySelector("[onclick=\"switchTab('codes')\"]").classList.add("active"),document.getElementById("tab-codes").classList.remove("hidden")):"versions"===e?(document.querySelector("[onclick=\"switchTab('versions')\"]").classList.add("active"),document.getElementById("tab-versions").classList.remove("hidden")):"stats"===e&&(document.querySelector("[onclick=\"switchTab('stats')\"]").classList.add("active"),document.getElementById("tab-stats").classList.remove("hidden"),updateStatsDisplay(),loadOrdersList())}function getCodes(){try{return JSON.parse(localStorage.getItem("discountCodes")||"{}")}catch{return{}}}function saveCodes(e){localStorage.setItem("discountCodes",JSON.stringify(e))}function loadCodes(){const e=getCodes(),t=document.getElementById("codes-list");t.innerHTML="",0!==Object.keys(e).length?Object.entries(e).forEach(([e,s])=>{const n=document.createElement("div");n.className="glass-input p-4 rounded-lg",n.innerHTML=`\n      <div class="flex justify-between items-start mb-2">\n        <div>\n          <p class="font-bold text-lg text-purple-400">${e}</p>\n          <p class="text-sm text-gray-400">${s.description}</p>\n        </div>\n        <button onclick="deleteCode('${e}')" class="delete-btn glass px-3 py-1 rounded-lg text-red-400 hover:text-red-300 transition text-sm">\n          Supprimer\n        </button>\n      </div>\n      <div class="flex gap-4 text-sm">\n        <span class="text-gray-400">Type: <span class="text-white">${"percentage"===s.type?"Pourcentage":"Fixe"}</span></span>\n        <span class="text-gray-400">Valeur: <span class="text-white">${s.value}${"percentage"===s.type?"%":"‚Ç¨"}</span></span>\n      </div>\n    `,t.appendChild(n)}):t.innerHTML='<p class="text-gray-500 text-center py-8">Aucun code cr√©√©</p>'}function addCode(){const e=document.getElementById("code-name").value.trim().toUpperCase(),t=document.getElementById("code-type").value,s=parseFloat(document.getElementById("code-value").value),n=document.getElementById("code-desc").value.trim();if(!e||!s||s<=0||!n)return void showCodeMessage("Veuillez remplir tous les champs","error");const o=getCodes();o[e]?showCodeMessage("Ce code existe d√©j√†","error"):(o[e]={type:t,value:s,description:n},saveCodes(o),document.getElementById("code-name").value="",document.getElementById("code-value").value="",document.getElementById("code-desc").value="",loadCodes(),showCodeMessage("Code cr√©√© avec succ√®s !","success"))}function deleteCode(e){if(!confirm(`Supprimer le code "${e}" ?`))return;const t=getCodes();delete t[e],saveCodes(t),loadCodes(),showCodeMessage("Code supprim√©","success")}function showCodeMessage(e,t){const s=document.getElementById("code-message");s.textContent=e,s.className="mt-4 p-3 rounded-lg "+("success"===t?"success-msg":"error-msg"),s.classList.remove("hidden"),setTimeout(()=>s.classList.add("hidden"),3e3)}async function loadVersionHistory(){const e=document.getElementById("version-history");e.innerHTML='<p class="text-gray-500 text-center py-8">Chargement...</p>';try{const t=await fetch("http://localhost:3001/api/versions/content"),s=await t.json();if(e.innerHTML="",0===s.length)return void(e.innerHTML='<p class="text-gray-500 text-center py-8">Aucune version enregistr√©e</p>');s.slice().reverse().forEach((t,s)=>{const n=document.createElement("div");n.className="glass-input p-4 rounded-lg relative";const o=new Date(t.date).toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}),r=0===s;n.innerHTML=`\n        <div class="flex justify-between items-start mb-2">\n          <div class="flex-1">\n            <div class="flex items-center gap-2 mb-1">\n              <p class="font-bold text-lg text-purple-400">v${t.version}</p>\n              ${r?'<span class="glass px-2 py-1 rounded text-xs text-green-400">‚óè Actuelle</span>':""}\n            </div>\n            <p class="text-xs text-gray-500">${o}</p>\n          </div>\n          <button onclick="deleteVersionAPI('${t.version}')" class="delete-btn glass px-3 py-1 rounded-lg text-xs text-red-400 hover:bg-red-400/20 transition border border-red-400/30">\n            Supprimer\n          </button>\n        </div>\n        ${t.previous?`<p class="text-sm text-gray-400 mb-2">‚Üê Depuis v${t.previous}</p>`:""}\n        ${t.notes?`<p class="text-sm text-gray-300 whitespace-pre-line mt-2 pt-2 border-t border-white/10">${t.notes}</p>`:""}\n      `,e.appendChild(n)})}catch(t){console.error("‚ùå Erreur chargement versions:",t),e.innerHTML='<p class="text-red-400 text-center py-8">Erreur de connexion √† l\'API</p>'}}async function prepareVersion(){const e=document.getElementById("version-number").value.trim(),t=document.getElementById("version-notes").value.trim(),s=document.getElementById("version-date").value,n=document.getElementById("version-time").value;if(!e)return void showVersionMessage("Veuillez entrer un num√©ro de version","error");if(!validateVersion(e))return void showVersionMessage("Format invalide (max 10 caract√®res: lettres, chiffres, points)","error");let o;o=s&&n?new Date(`${s}T${n}`).toISOString():s?new Date(s).toISOString():(new Date).toISOString();const r=getCurrentVersion(),a={version:e,previous:r,date:o,notes:t,title:`Version ${e}`,description:t.split("\n")[0]||""};try{const t=await fetch("http://localhost:3001/api/versions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),s=await t.json();s.success?(localStorage.setItem("currentAppVersion",e),loadVersionHistory(),updateCurrentVersionDisplay(),document.getElementById("version-number").value="",document.getElementById("version-notes").value="",document.getElementById("version-date").value="",document.getElementById("version-time").value="",showVersionMessage(`‚úÖ Version ${e} cr√©√©e avec succ√®s !`,"success"),console.log("‚úÖ Version envoy√©e √† l'API:",s)):showVersionMessage("Erreur lors de la cr√©ation","error")}catch(i){console.error("‚ùå Erreur envoi version:",i),showVersionMessage("Erreur de connexion √† l'API","error")}}async function deleteVersionAPI(e){const t=getCurrentVersion();if(e!==t){if(confirm(`Voulez-vous vraiment supprimer la version ${e} ?\n\nCette action est irr√©versible.`))try{const t=await fetch(`http://localhost:3001/api/versions/${e}`,{method:"DELETE"}),s=await t.json();s.success?(loadVersionHistory(),showVersionMessage(`‚úÖ Version ${e} supprim√©e !`,"success")):showVersionMessage(s.error||"Erreur lors de la suppression","error")}catch(s){console.error("‚ùå Erreur suppression version:",s),showVersionMessage("Erreur de connexion √† l'API","error")}}else showVersionMessage("Impossible de supprimer la version actuelle","error")}function validateVersion(e){return!(!e||e.length>10)&&!!/^[0-9a-zA-Z\.]+$/.test(e)}function getCurrentVersion(){return localStorage.getItem("currentAppVersion")||"1.0.0"}function updateCurrentVersionDisplay(){const e=getCurrentVersion(),t=document.getElementById("current-version-badge");t&&(t.textContent=`v${e}`)}function showVersionMessage(e,t){const s=document.getElementById("version-message");s.textContent=e,s.className="mt-4 p-3 rounded-lg "+("success"===t?"success-msg":"error-msg"),s.classList.remove("hidden"),setTimeout(()=>s.classList.add("hidden"),3e3)}function getOrders(){try{return JSON.parse(localStorage.getItem("orders")||"[]")}catch{return[]}}function saveOrders(e){localStorage.setItem("orders",JSON.stringify(e))}function calculateStats(){const e=getOrders(),t=new Date,s=t.getMonth(),n=t.getFullYear();let o=0,r=0,a=0,i=0,d=0;e.forEach(e=>{const t=new Date(e.date),c=parseFloat(e.amount)||0;d+=c,t.getFullYear()===n&&(a+=c,i++,t.getMonth()===s&&(o+=c,r++))});const c=e.length>0?d/e.length:0;return{monthlyRevenue:o,monthlyOrders:r,yearlyRevenue:a,yearlyOrders:i,averageOrder:c}}function updateStatsDisplay(){const e=calculateStats(),t=new Date;document.getElementById("revenue-monthly").textContent=`‚Ç¨${e.monthlyRevenue.toFixed(2)}`,document.getElementById("orders-monthly").textContent=e.monthlyOrders,document.getElementById("revenue-yearly").textContent=`‚Ç¨${e.yearlyRevenue.toFixed(2)}`,document.getElementById("orders-yearly").textContent=e.yearlyOrders,document.getElementById("average-order").textContent=`‚Ç¨${e.averageOrder.toFixed(2)}`;const s=["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];document.getElementById("current-month-label").textContent=`${s[t.getMonth()]} ${t.getFullYear()}`,document.getElementById("current-year-label").textContent=t.getFullYear()}function loadOrdersList(){const e=getOrders(),t=document.getElementById("orders-list");t.innerHTML="",0!==e.length?e.slice().reverse().forEach((s,n)=>{const o=document.createElement("div");o.className="glass-input p-3 rounded-lg flex justify-between items-center";const r=new Date(s.date).toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"});o.innerHTML=`\n      <div class="flex-1">\n        <div class="flex items-center gap-2">\n          <span class="font-bold text-green-400">‚Ç¨${parseFloat(s.amount).toFixed(2)}</span>\n          <span class="text-xs text-gray-500">${r}</span>\n        </div>\n        ${s.description?`<p class="text-xs text-gray-400 mt-1">${s.description}</p>`:""}\n      </div>\n      <button onclick="deleteOrder(${e.length-1-n})" class="glass px-3 py-1 rounded text-xs text-red-400 hover:bg-red-400/20 transition">\n        Supprimer\n      </button>\n    `,t.appendChild(o)}):t.innerHTML='<p class="text-gray-500 text-center py-8">Aucune commande enregistr√©e</p>'}function addOrder(){const e=document.getElementById("order-amount").value.trim(),t=document.getElementById("order-date").value,s=document.getElementById("order-description").value.trim();if(!e||parseFloat(e)<=0)return void showOrderMessage("Veuillez entrer un montant valide","error");if(!t)return void showOrderMessage("Veuillez s√©lectionner une date","error");const n=getOrders();n.push({id:Date.now(),amount:parseFloat(e),date:t,description:s,createdAt:(new Date).toISOString()}),saveOrders(n),document.getElementById("order-amount").value="",document.getElementById("order-date").value="",document.getElementById("order-description").value="",updateStatsDisplay(),loadOrdersList(),showOrderMessage("Commande ajout√©e avec succ√®s !","success")}function deleteOrder(e){if(!confirm("Supprimer cette commande ?"))return;const t=getOrders();t.splice(e,1),saveOrders(t),updateStatsDisplay(),loadOrdersList(),showOrderMessage("Commande supprim√©e","success")}function clearAllOrders(){confirm("Voulez-vous vraiment supprimer TOUTES les commandes ?\n\nCette action est irr√©versible.")&&(localStorage.removeItem("orders"),updateStatsDisplay(),loadOrdersList(),showOrderMessage("Toutes les commandes ont √©t√© supprim√©es","success"))}function showOrderMessage(e,t){const s=document.getElementById("order-message");s.textContent=e,s.className="mt-4 p-3 rounded-lg "+("success"===t?"success-msg":"error-msg"),s.classList.remove("hidden"),setTimeout(()=>s.classList.add("hidden"),3e3)}window.addEventListener("DOMContentLoaded",()=>{isSessionValid()&&(console.log("‚úÖ Session active d√©tect√©e"),document.getElementById("error-page").classList.add("hidden"),document.getElementById("admin-panel").style.display="block",loadCodes(),loadVersionHistory(),updateStatsDisplay(),startSessionTimer())}),loadCodes(),loadVersionHistory(),updateCurrentVersionDisplay(),updateStatsDisplay();