const API_URL="https://mythic-api.onrender.com/api/order";function getDiscountCodes(){try{const e=localStorage.getItem("discountCodes");return e?JSON.parse(e):{}}catch(e){return console.error("Erreur lecture codes promo:",e),{}}}!function(){try{const e=window.location.origin+window.location.pathname;window.history.replaceState({},document.title,e)}catch(e){console.log("âš ï¸ Impossible de nettoyer l'URL:",e)}}();let screenshotTaken=!1,isSubmitting=!1,selectedVendor=".uwg9",orderData={};function addPageAnimations(){console.log("ðŸŽ¨ Ajout des animations...");const e=document.querySelector("main > div:first-child");e&&e.classList.add("animate-fadeInUp");const o=document.querySelector("main > div:nth-child(2)");o&&o.classList.add("animate-scaleIn","delay-200","shine-effect","glow-on-hover");const t=document.querySelectorAll(".grid.grid-cols-1.md\\:grid-cols-2 > div");t[0]&&t[0].classList.add("animate-slideInLeft","delay-300"),t[1]&&t[1].classList.add("animate-slideInRight","delay-300");document.querySelectorAll("h3").forEach((e,o)=>{e.classList.add("animate-fadeInUp","delay-"+100*(o+4))});const n=document.getElementById("submit-order");n&&n.classList.add("animate-fadeInUp","delay-400");const a=document.querySelector("main > div:nth-last-child(2)");if(a){a.classList.add("animate-fadeInUp","delay-300","shine-effect");const e=a.querySelector("h3");e&&e.classList.add("animate-float")}console.log("âœ… Animations ajoutÃ©es")}function animateOrderItems(){const e=document.getElementById("order-items");if(!e)return;new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.length>0&&e.addedNodes.forEach(e=>{1===e.nodeType&&e.classList&&(e.classList.add("order-item"),console.log("âœ¨ Animation ajoutÃ©e Ã  l'article"))})})}).observe(e,{childList:!0,subtree:!1}),console.log("ðŸ‘€ Observer activÃ© pour les articles")}function animatePromoSection(){const e=document.getElementById("promo-section");if(!e)return;new MutationObserver(o=>{o.forEach(o=>{"attributes"===o.type&&"class"===o.attributeName&&(e.classList.contains("hidden")||console.log("ðŸŽ‰ Code promo affichÃ© avec animation"))})}).observe(e,{attributes:!0,attributeFilter:["class"]})}function initializeAnimations(){console.log("ðŸŽ¬ Initialisation des animations..."),setTimeout(()=>{addPageAnimations(),animateOrderItems(),animatePromoSection()},100)}function decryptData(e){try{const o=decodeURIComponent(atob(e)).replace("checkout_secure_key_2024","");return JSON.parse(o)}catch(e){return console.error("Erreur dÃ©chiffrement:",e),null}}function generateOrderNumber(){return`PM-${Math.floor(1e5+9e5*Math.random())}-${Math.floor(1e3+9e3*Math.random())}`}function getEstimatedDelivery(e){const o=(e||"").toLowerCase();return o.includes("express")?"2-4H":(o.includes("standard")||o.includes("classique"),"6-12H")}function loadOrderData(){console.log("ðŸ“¦ Chargement des donnÃ©es de commande...");const e=localStorage.getItem("secureCheckoutData"),o=e?decryptData(e):null,t=JSON.parse(localStorage.getItem("cart")||"[]"),n=localStorage.getItem("selectedShippingMethod")||"Livraison Standard",a=localStorage.getItem("selectedPaymentMethod")||"PayPal";console.log("ðŸ“‹ DonnÃ©es rÃ©cupÃ©rÃ©es:",{formData:o?"âœ…":"âŒ",cart:t.length+" articles",shippingMethod:n,paymentMethod:a}),orderData={orderNumber:generateOrderNumber(),orderDate:(new Date).toISOString(),discordname:o?.customerInfo?.discord||o?.customerInfo?.discordname||"Non renseignÃ©",email:o?.customerInfo?.email||"Non renseignÃ©",discord:o?.customerInfo?.discord||o?.customerInfo?.discordname||"Non renseignÃ©",orderItems:t,shippingMethod:{name:n,price:n.toLowerCase().includes("express")?2.5:0,delivery:getEstimatedDelivery(n)},paymentMethod:a,status:"CONFIRMED"},console.log("âœ… OrderData crÃ©Ã©:",orderData)}function populateOrderData(){console.log("ðŸ” Remplissage des informations client...");const e={"order-number":orderData.orderNumber,"order-date":new Date(orderData.orderDate).toLocaleDateString("fr-FR"),"contact-name":orderData.discord||orderData.discordname||"Non renseignÃ©","contact-email":orderData.email,"contact-discord":orderData.discord,"shipping-method":orderData.shippingMethod.name,"shipping-delivery":orderData.shippingMethod.delivery,"payment-method":orderData.paymentMethod};Object.entries(e).forEach(([e,o])=>{const t=document.getElementById(e);t?(t.textContent=o,console.log(`âœ… ${e} = ${o}`)):console.warn(`âš ï¸ Element ${e} non trouvÃ©`)}),console.log("âœ… Informations client remplies")}function populateOrderItems(){console.log("ðŸ›’ Affichage des articles commandÃ©s...");const e=document.getElementById("order-items");e?(e.innerHTML="",console.log("ðŸ“¦ Affichage de",orderData.orderItems.length,"articles"),orderData.orderItems.forEach((o,t)=>{const n=document.createElement("div");n.className="flex justify-between items-center py-3 border-b border-[rgba(212,175,55,0.15)] last:border-b-0 transition-all duration-200";const a=document.createElement("div");a.className="text-text-white text-sm font-semibold",a.textContent=o.name;const r=document.createElement("span");r.className="bg-gradient-to-br from-gold-light to-gold-primary text-background-dark text-xs px-2 py-1 rounded-xl ml-2 font-bold shadow-[0_2px_6px_rgba(212,175,55,0.3)]",r.textContent=`x${o.quantity||1}`,a.appendChild(r);const c=document.createElement("div");c.className="text-gold-primary font-bold text-sm drop-shadow-[0_1px_3px_rgba(212,175,55,0.3)] item-price",c.textContent=`â‚¬${(o.price*o.quantity).toFixed(2)}`,n.appendChild(a),n.appendChild(c),e.appendChild(n),console.log(`  ${t+1}. ${o.name} x${o.quantity} = â‚¬${(o.price*o.quantity).toFixed(2)}`)})):console.error("âŒ Container order-items non trouvÃ©")}function calculateAndDisplayTotals(){console.log("ðŸ’° Calcul des totaux...");const e=JSON.parse(localStorage.getItem("appliedDiscount")||"null");console.log("ðŸŽ Code promo:",e?e.code:"Aucun");const o=orderData.orderItems.reduce((e,o)=>e+o.price*o.quantity,0),t=.2*o,n=o+t;let a=0,r=n;e&&(a="percentage"===e.type?n*(e.value/100):e.value,r=Math.max(0,n-a));const c=orderData.shippingMethod.price,i=r+c;orderData.appliedDiscount=e,orderData.discountAmount=a,console.log("ðŸ“Š DÃ©tails:",{subtotalHT:o.toFixed(2),tva:t.toFixed(2),promo:a.toFixed(2),shipping:c.toFixed(2),total:i.toFixed(2)});const s=(e,o)=>{const t=document.getElementById(e);t?(t.textContent=o,console.log(`  âœ… ${e}: ${o}`)):console.error(`  âŒ ${e} non trouvÃ©`)};s("subtotal-ht",`â‚¬${o.toFixed(2)}`),s("tva-amount",`â‚¬${t.toFixed(2)}`),s("shipping-type",orderData.shippingMethod.name),s("shipping-cost",c>0?`â‚¬${c.toFixed(2)}`:"Gratuit");const d=document.getElementById("promo-section");e&&a>0?d&&(d.classList.remove("hidden"),s("promo-code-name",e.code),s("promo-discount",`-â‚¬${a.toFixed(2)}`),console.log("  ðŸŽ‰ Section promo affichÃ©e")):d&&(d.classList.add("hidden"),console.log("  âšª Pas de promo"));const l=document.getElementById("total-original"),u=document.getElementById("total-cost");e&&a>0?(l&&(l.textContent=`â‚¬${(n+c).toFixed(2)}`,l.classList.remove("hidden")),u&&(u.textContent=`â‚¬${i.toFixed(2)}`,u.classList.add("text-green-400")),console.log("  ðŸ’š Prix barrÃ© activÃ©")):(l&&l.classList.add("hidden"),u&&(u.textContent=`â‚¬${i.toFixed(2)}`,u.classList.remove("text-green-400")),console.log("  ðŸ’› Prix normal"))}async function submitOrderToServer(){if(isSubmitting)return!1;isSubmitting=!0,console.log("ðŸ“¤ Envoi de la commande au serveur..."),console.log("ðŸ¤– Les notifications Discord seront envoyÃ©es automatiquement !");try{const e={...orderData,selectedVendor:selectedVendor,submittedAt:(new Date).toISOString()};console.log("ðŸ“¦ DonnÃ©es envoyÃ©es:",{orderNumber:e.orderNumber,email:e.email,discord:e.discord,items:e.orderItems.length,status:e.status});const o=await fetch(`${API_URL}/api/order`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)});if(!o.ok)return console.error(`âŒ Erreur HTTP: ${o.status}`),!1;const t=await o.json();return t.success?(console.log("âœ… Commande envoyÃ©e:",t.order?.orderNumber),console.log("ðŸ¤– Statut Discord:",t.discordStatus||"en cours d'envoi"),console.log("ðŸ“§ Statut Email:",t.emailStatus||"en cours d'envoi"),orderData.discord&&"Non renseignÃ©"!==orderData.discord&&console.log("ðŸ’¬ Notification Discord envoyÃ©e Ã :",orderData.discord),!0):(console.error("âŒ Ã‰chec:",t.error),!1)}catch(e){return console.error("âŒ Erreur:",e),!1}finally{isSubmitting=!1}}function clearStorage(){console.log("ðŸ§¹ Nettoyage du localStorage..."),localStorage.removeItem("cart"),localStorage.removeItem("checkoutData"),localStorage.removeItem("secureCheckoutData"),localStorage.removeItem("appliedDiscount"),localStorage.removeItem("selectedShippingMethod"),localStorage.removeItem("selectedPaymentMethod"),sessionStorage.removeItem("checkoutData"),console.log("âœ… Nettoyage terminÃ©")}function openModal(e){e&&(e.classList.remove("hidden"),e.style.removeProperty("display"),e.style.setProperty("display","flex","important"))}function closeModal(e){e&&(e.style.removeProperty("display"),e.classList.add("hidden"))}document.addEventListener("DOMContentLoaded",function(){console.log("ðŸš€ ================================="),console.log("ðŸš€ INITIALISATION CONFIRMATION PAGE"),console.log("ðŸš€ =================================");const e={submitButton:document.getElementById("submit-order"),screenshotModal:document.getElementById("screenshot-modal"),vendorModal:document.getElementById("vendor-modal"),confirmationModal:document.getElementById("confirmation-modal"),notYetBtn:document.getElementById("not-yet-btn"),screenshotTakenBtn:document.getElementById("screenshot-taken-btn"),continueToVendorBtn:document.getElementById("continue-to-vendor"),confirmationOkBtn:document.getElementById("confirmation-ok-btn")};console.log("ðŸ” VÃ©rification des Ã©lÃ©ments DOM:"),console.log("  Submit button:",e.submitButton?"âœ…":"âŒ"),console.log("  Screenshot modal:",e.screenshotModal?"âœ…":"âŒ"),console.log("  Vendor modal:",e.vendorModal?"âœ…":"âŒ"),console.log("  Confirmation modal:",e.confirmationModal?"âœ…":"âŒ"),loadOrderData(),populateOrderData(),populateOrderItems(),calculateAndDisplayTotals(),e.submitButton?(e.submitButton.disabled=!1,console.log("âœ… Bouton de soumission activÃ©"),e.submitButton.addEventListener("click",async function(o){if(o.preventDefault(),console.log("ðŸ–±ï¸ Clic sur le bouton de soumission"),!screenshotTaken)return console.log("ðŸ“¸ Ouverture modal de capture d'Ã©cran"),void openModal(e.screenshotModal);console.log("ðŸ‘¤ Ouverture modal de sÃ©lection vendeur"),openModal(e.vendorModal)})):console.error("âŒ Bouton submit-order non trouvÃ© !"),e.notYetBtn&&e.notYetBtn.addEventListener("click",function(){console.log("âŒ Utilisateur n'a pas pris la capture"),closeModal(e.screenshotModal)}),e.screenshotTakenBtn&&e.screenshotTakenBtn.addEventListener("click",function(){console.log("âœ… Capture d'Ã©cran confirmÃ©e"),screenshotTaken=!0,closeModal(e.screenshotModal),e.submitButton&&(e.submitButton.textContent="Finaliser la commande"),setTimeout(()=>{openModal(e.vendorModal)},300)}),e.continueToVendorBtn&&e.continueToVendorBtn.addEventListener("click",async function(){console.log("ðŸš€ Finalisation de la commande"),console.log("ðŸ¤– Le bot Discord va envoyer les notifications..."),closeModal(e.vendorModal),e.submitButton&&(e.submitButton.textContent="â³ Envoi en cours...",e.submitButton.disabled=!0),setTimeout(async()=>{if(await submitOrderToServer()){console.log("âœ… Commande validÃ©e !"),console.log("ðŸ¤– Notifications Discord envoyÃ©es !"),console.log("ðŸ“§ Email de confirmation envoyÃ© !");try{window.open("https://discord.gg/beC8cFZaXH","_blank"),console.log("ðŸ“± Discord ouvert")}catch(e){console.log("âš ï¸ Impossible d'ouvrir Discord:",e)}setTimeout(()=>{openModal(e.confirmationModal),console.log("ðŸŽ‰ Modal de confirmation affichÃ©e")},500)}else e.submitButton&&(e.submitButton.textContent="RÃ©essayer",e.submitButton.disabled=!1),alert("âŒ Erreur lors de l'envoi. Veuillez rÃ©essayer.")},2e3)}),e.confirmationOkBtn&&e.confirmationOkBtn.addEventListener("click",function(e){e.preventDefault(),console.log("âœ… Retour Ã  l'accueil"),clearStorage(),window.location.href="/index.html"}),[e.screenshotModal,e.vendorModal,e.confirmationModal].forEach(e=>{e&&e.addEventListener("click",function(o){o.target===e&&closeModal(e)})}),initializeAnimations(),console.log("ðŸš€ ================================="),console.log("ðŸš€ INITIALISATION TERMINÃ‰E"),console.log("ðŸš€ ðŸ¤– Bot Discord prÃªt Ã  envoyer !"),console.log("ðŸš€ =================================")});