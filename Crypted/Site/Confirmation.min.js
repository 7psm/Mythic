import{decryptData,formatPrice}from"../utils.js";const API_URL=window.location.hostname.includes("localhost")?"http://localhost:3001":"https://mythic-api.onrender.com";!function(){try{const e=window.location.origin+window.location.pathname;window.history.replaceState({},document.title,e)}catch(e){}}();let screenshotTaken=!1,isSubmitting=!1,selectedVendor=".uwg9",orderData={};function generateOrderNumber(){const e=Math.floor(1e5+9e5*Math.random()),t=Math.floor(1e3+9e3*Math.random());return`PM-${e}-${t}`}function getEstimatedDelivery(e){const t=(e||"").toLowerCase();return t.includes("express")?"2-4H":(t.includes("standard")||t.includes("classique"),"6-12H")}function loadOrderData(){const e=localStorage.getItem("secureCheckoutData"),t=e?decryptData(e):null,o=JSON.parse(localStorage.getItem("cart")||"[]"),n=localStorage.getItem("selectedShippingMethod")||"Livraison Standard",a=localStorage.getItem("selectedPaymentMethod")||"PayPal";orderData={orderNumber:generateOrderNumber(),orderDate:(new Date).toISOString(),discordname:t?.customerInfo?.discord||t?.customerInfo?.discordname||"Non renseigne",discord:t?.customerInfo?.discord||t?.customerInfo?.discordname||"Non renseigne",clientName:t?.customerInfo?.name||"",orderItems:o,shippingMethod:{name:n,price:n.toLowerCase().includes("express")?2.5:0,delivery:getEstimatedDelivery(n)},paymentMethod:a,status:"CONFIRMED"}}function populateOrderData(){const e={"order-number":orderData.orderNumber,"order-date":new Date(orderData.orderDate).toLocaleDateString("fr-FR"),"contact-name":orderData.clientName||orderData.discord||orderData.discordname||"Non renseigne","contact-discord":orderData.discord,"shipping-method":orderData.shippingMethod.name,"shipping-delivery":orderData.shippingMethod.delivery,"payment-method":orderData.paymentMethod};Object.entries(e).forEach(([e,t])=>{const o=document.getElementById(e);o&&(o.textContent=t)})}function populateOrderItems(){const e=document.getElementById("order-items");e&&(e.innerHTML="",orderData.orderItems.forEach(t=>{const o=document.createElement("div");o.className="flex justify-between items-center py-3 border-b border-[rgba(212,175,55,0.15)] last:border-b-0 transition-all duration-200";const n=document.createElement("div");n.className="text-text-white text-sm font-semibold",n.textContent=t.name;const a=document.createElement("span");a.className="bg-gradient-to-br from-gold-light to-gold-primary text-background-dark text-xs px-2 py-1 rounded-xl ml-2 font-bold shadow-[0_2px_6px_rgba(212,175,55,0.3)]",a.textContent=`x${t.quantity||1}`,n.appendChild(a);const r=document.createElement("div");r.className="text-gold-primary font-bold text-sm drop-shadow-[0_1px_3px_rgba(212,175,55,0.3)] item-price",r.textContent=formatPrice(t.price*t.quantity),o.appendChild(n),o.appendChild(r),e.appendChild(o)}))}function calculateAndDisplayTotals(){const e=JSON.parse(localStorage.getItem("appliedDiscount")||"null"),t=orderData.orderItems.reduce((e,t)=>e+t.price*t.quantity,0),o=.2*t,n=t+o;let a=0;e&&(a="percentage"===e.type?n*(e.value/100):e.value);const r=Math.max(0,n-a),d=orderData.shippingMethod.price,s=r+d;orderData.appliedDiscount=e,orderData.discountAmount=a;const updateElement=(e,t)=>{const o=document.getElementById(e);o&&(o.textContent=t)};updateElement("subtotal-ht",formatPrice(t)),updateElement("tva-amount",formatPrice(o)),updateElement("shipping-type",orderData.shippingMethod.name),updateElement("shipping-cost",d>0?formatPrice(d):"Gratuit");const i=document.getElementById("promo-section");e&&a>0?i&&(i.classList.remove("hidden"),updateElement("promo-code-name",e.code),updateElement("promo-discount",`-${formatPrice(a)}`)):i&&i.classList.add("hidden");const c=document.getElementById("total-original"),l=document.getElementById("total-cost");e&&a>0?(c&&(c.textContent=formatPrice(n+d),c.classList.remove("hidden")),l&&(l.textContent=formatPrice(s),l.classList.add("text-green-400"))):(c&&c.classList.add("hidden"),l&&(l.textContent=formatPrice(s),l.classList.remove("text-green-400")))}async function submitOrderToServer(){if(isSubmitting)return!1;isSubmitting=!0;try{const e={...orderData,selectedVendor:selectedVendor,submittedAt:(new Date).toISOString()},t=await fetch(`${API_URL}/api/order`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)});if(!t.ok){const e=await t.text().catch(()=>"");return console.error(`❌ Erreur HTTP ${t.status}:`,e),!1}const o=await t.json();return!!o.success||(console.error("❌ Échec de la commande:",o.error),!1)}catch(e){return console.error("❌ Erreur lors de l'envoi:",e.message),!1}finally{isSubmitting=!1}}function clearStorage(){localStorage.removeItem("cart"),localStorage.removeItem("checkoutData"),localStorage.removeItem("secureCheckoutData"),localStorage.removeItem("appliedDiscount"),localStorage.removeItem("selectedShippingMethod"),localStorage.removeItem("selectedPaymentMethod"),sessionStorage.removeItem("checkoutData")}function openModal(e){e&&(e.classList.remove("hidden"),e.style.removeProperty("display"),e.style.setProperty("display","flex","important"))}function closeModal(e){e&&(e.style.removeProperty("display"),e.classList.add("hidden"))}function addPageAnimations(){const e=document.querySelector("main > div:first-child");e&&e.classList.add("animate-fadeInUp");const t=document.querySelector("main > div:nth-child(2)");t&&t.classList.add("animate-scaleIn","delay-200","shine-effect","glow-on-hover");const o=document.querySelectorAll(".grid.grid-cols-1.md\\:grid-cols-2 > div");o[0]&&o[0].classList.add("animate-slideInLeft","delay-300"),o[1]&&o[1].classList.add("animate-slideInRight","delay-300");const n=document.querySelectorAll("h3");n.forEach((e,t)=>{e.classList.add("animate-fadeInUp","delay-"+100*(t+4))});const a=document.getElementById("submit-order");a&&a.classList.add("animate-fadeInUp","delay-400");const r=document.querySelector("main > div:nth-last-child(2)");if(r){r.classList.add("animate-fadeInUp","delay-300","shine-effect");const e=r.querySelector("h3");e&&e.classList.add("animate-float")}}function animateOrderItems(){const e=document.getElementById("order-items");if(!e)return;const t=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.length>0&&e.addedNodes.forEach(e=>{1===e.nodeType&&e.classList&&e.classList.add("order-item")})})});t.observe(e,{childList:!0,subtree:!1})}function initializeAnimations(){setTimeout(()=>{addPageAnimations(),animateOrderItems()},100)}document.addEventListener("DOMContentLoaded",function(){const e={submitButton:document.getElementById("submit-order"),screenshotModal:document.getElementById("screenshot-modal"),vendorModal:document.getElementById("vendor-modal"),confirmationModal:document.getElementById("confirmation-modal"),notYetBtn:document.getElementById("not-yet-btn"),screenshotTakenBtn:document.getElementById("screenshot-taken-btn"),continueToVendorBtn:document.getElementById("continue-to-vendor"),confirmationOkBtn:document.getElementById("confirmation-ok-btn")};loadOrderData(),populateOrderData(),populateOrderItems(),calculateAndDisplayTotals(),e.submitButton&&(e.submitButton.disabled=!1,e.submitButton.addEventListener("click",async function(t){t.preventDefault(),openModal(screenshotTaken?e.vendorModal:e.screenshotModal)})),e.notYetBtn&&e.notYetBtn.addEventListener("click",()=>{closeModal(e.screenshotModal)}),e.screenshotTakenBtn&&e.screenshotTakenBtn.addEventListener("click",()=>{screenshotTaken=!0,closeModal(e.screenshotModal),e.submitButton&&(e.submitButton.textContent="Finaliser la commande"),setTimeout(()=>openModal(e.vendorModal),300)}),e.continueToVendorBtn&&e.continueToVendorBtn.addEventListener("click",async()=>{closeModal(e.vendorModal),e.submitButton&&(e.submitButton.textContent="Envoi en cours...",e.submitButton.disabled=!0),setTimeout(async()=>{const t=await submitOrderToServer();if(t){try{window.open("https://discord.gg/beC8cFZaXH","_blank")}catch(o){}setTimeout(()=>{openModal(e.confirmationModal)},500)}else e.submitButton&&(e.submitButton.textContent="Réessayer",e.submitButton.disabled=!1),alert("Erreur lors de l'envoi. Veuillez réessayer.")},2e3)}),e.confirmationOkBtn&&e.confirmationOkBtn.addEventListener("click",e=>{e.preventDefault(),clearStorage(),window.location.href="/index.html"}),[e.screenshotModal,e.vendorModal,e.confirmationModal].forEach(e=>{e&&e.addEventListener("click",t=>{t.target===e&&closeModal(e)})}),initializeAnimations()});